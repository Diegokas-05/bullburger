{% extends 'base.html' %}
{% block title %}Lista de Empleados{% endblock %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/listas-usuarios.css' %}">

<div class="clientes-container">
    <div class="clientes-header">
        <h2>Lista de Empleados</h2>
        <div class="buscador">
            <form method="GET">
                <input type="text" name="buscar" placeholder="Buscar por nombre o correo" value="{{ request.GET.buscar }}">
                <button type="submit">Buscar</button>
            </form>
            <button class="btn-crear" onclick="openCreateEmpleadoModal()">Crear</button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="tabla-clientes" id="tabla-empleados">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Direcci√≥n</th>
                    <th>Creado en</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in empleados %}
                <tr class="data-row" data-id="{{ emp.id }}">
                    <td>{{ emp.id }}</td>
                    <td class="c-nombre">{{ emp.nombre }}</td>
                    <td class="c-email">{{ emp.email }}</td>
                    <td class="c-telefono">{{ emp.telefono|default:"-" }}</td>
                    <td class="c-direccion">{{ emp.direccion|default:"-" }}</td>
                    
                    <td>{{ emp.creado_en|date:"d/m/Y" }}</td>
                    
                    <td>
                        <div class="action-buttons-small">
                            <button class="btn-action btn-edit" onclick="openEditEmpleadoModal({{ emp.id }})">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="confirmDeleteEmpleado({{ emp.id }}, '{{ emp.nombre|escapejs }}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="sin-resultados">No se encontraron empleados.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="createEmpleadoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Crear Empleado</h2>
            <span class="close" onclick="closeCreateEmpleadoModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <form id="createEmpleadoForm" onsubmit="return submitCreateEmpleado(event)" novalidate>
                {% csrf_token %}<div class="form-group">
                    <label for="c_nombre">Nombre *</label>
                    <input type="text" id="c_nombre" required class="form-control">
                    <div class="error-message" id="c_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="c_email">Correo *</label>
                    <input type="email" id="c_email" required class="form-control">
                    <div class="error-message" id="c_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="c_telefono">Tel√©fono</label>
                    <input type="text" id="c_telefono" class="form-control">
                    <div class="error-message" id="c_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="c_direccion">Direcci√≥n</label>
                    <input type="text" id="c_direccion" class="form-control">
                </div>
                <div class="form-group">
                    <label for="c_password">Contrase√±a *</label>
                    <input type="password" id="c_password" required class="form-control">
                    <div class="error-message" id="c_passwordError"></div>
                </div>
                <div class="form-group">
                    <label for="c_password2">Confirmar contrase√±a *</label>
                    <input type="password" id="c_password2" required class="form-control">
                    <div class="error-message" id="c_password2Error"></div>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeCreateEmpleadoModal()">Cancelar</button>
            <button type="submit" form="createEmpleadoForm" class="btn-save">Crear</button>
        </div>
    </div>
</div>

<div id="editEmpleadoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Empleado</h2>
            <span class="close" onclick="closeEditEmpleadoModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editEmpleadoForm" onsubmit="return submitEditEmpleado(event)" novalidate>
                {% csrf_token %}
                <input type="hidden" id="e_id">
                <div class="form-group">
                    <label for="e_nombre">Nombre *</label>
                    <input type="text" id="e_nombre" required class="form-control">
                    <div class="error-message" id="e_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="e_email">Correo *</label>
                    <input type="email" id="e_email" required class="form-control">
                    <div class="error-message" id="e_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="e_telefono">Tel√©fono</label>
                    <input type="text" id="e_telefono" class="form-control">
                    <div class="error-message" id="e_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="e_direccion">Direcci√≥n</label>
                    <input type="text" id="e_direccion" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeEditEmpleadoModal()">Cancelar</button>
            <button type="submit" form="editEmpleadoForm" class="btn-save">Actualizar</button>
        </div>
    </div>
</div>

<div id="customAlert" class="modal">
    <div class="modal-content" style="max-width: 450px; text-align: center; padding: 0;">
        <div class="custom-alert-header">
            <div class="custom-alert-icon">?</div> 
        </div>

        <div class="modal-body" style="padding: 30px 20px;">
            <h2 id="alertTitle" style="color: #333; font-size: 1.5rem; margin-bottom: 10px;">¬øConfirmar acci√≥n?</h2>
            <p id="alertMessage" style="color: #666; font-size: 1rem; margin-bottom: 30px;"></p>
            
            <div class="form-actions" style="justify-content: center; gap: 1rem;">
                <button type="button" class="btn-cancel" id="alertCancelBtn" onclick="closeCustomAlert()" 
                        style="background: #95a5a6; color: white; width: 100px;">
                    Cancelar
                </button>
                <button type="button" class="btn-save alert-ok-btn" id="alertConfirmBtn" 
                        style="background: #e74c3c; width: 100px; box-shadow: none;">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// (El resto de tu JavaScript se mantiene, pero aqu√≠ est√° la funci√≥n confirmDeleteEmpleado
// para asegurar que usa el nuevo modal)

// ===== FUNCIONES DEL SISTEMA DE ALERTAS (COMO MENU.HTML) =====

// Funci√≥n de alerta personalizada (igual que menu.html)
function showCustomAlert(title, message, confirmCallback = null) {
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('customAlert').style.display = 'block';
    
    const confirmBtn = document.getElementById('alertConfirmBtn');
    
    // Es crucial clonar para evitar m√∫ltiples listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    if (confirmCallback) {
        newConfirmBtn.onclick = function() {
            confirmCallback();
            closeCustomAlert();
        };
    } else {
        newConfirmBtn.onclick = closeCustomAlert;
    }
}

function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
}

// ===== ELIMINAR EMPLEADO USANDO SWEETALERT2 =====
function confirmDeleteEmpleado(id, nombre) {
    // 1. Mostrar la alerta de confirmaci√≥n
    Swal.fire({
        title: 'Confirmar Eliminaci√≥n',
        html: `¬øEst√°s seguro de que quieres eliminar al empleado "<strong>${nombre}</strong>"? <br>Esta acci√≥n no se puede deshacer.`,
        icon: 'question', // Usa el icono de pregunta nativo de SA2
        showCancelButton: true,
        confirmButtonText: 'Aceptar',
        cancelButtonText: 'Cancelar',
        // Opcional: para que Aceptar sea el color rojo que definimos en el CSS
        confirmButtonColor: '#d32f2f', 
        reverseButtons: true, // Pone el bot√≥n de Aceptar a la derecha, como en tu imagen
        customClass: {
            // Opcional: si quieres ajustar el tama√±o del t√≠tulo o el contenido
            title: 'swal-title-custom', 
            htmlContainer: 'swal-text-custom'
        }
    }).then((result) => {
        // 2. Si el usuario presiona "Aceptar"
        if (result.isConfirmed) {
            const csrftoken = getCookie('csrftoken'); 
            
            fetch(`/empleados/eliminar/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.ok) {
                    // Muestra una alerta de √©xito final (Estilo SweetAlert)
                    Swal.fire({
                        title: '¬°Eliminado!',
                        text: `El empleado ${nombre} ha sido eliminado.`,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Recargar la p√°gina despu√©s del √©xito
                        location.reload(); 
                    });
                } else {
                    // Muestra una alerta de error (Estilo SweetAlert)
                    Swal.fire('Error', resp.msg || 'No se pudo eliminar al empleado.', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Error en la solicitud al servidor.', 'error'));
        }
    });
}

// ===== LISTENERS =====
document.addEventListener('DOMContentLoaded', function() {
    // --- Formulario CREAR ---
    const c_nombre = document.getElementById('c_nombre');
    const c_email = document.getElementById('c_email');
    const c_telefono = document.getElementById('c_telefono');
    const c_password = document.getElementById('c_password');
    const c_password2 = document.getElementById('c_password2');

    if (c_nombre) {
        c_telefono.addEventListener('input', function() { formatPhone(this); });
        c_nombre.addEventListener('input', function() { validateNameInput(this); });
        c_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
        c_email.addEventListener('blur', function() { validateEmail(this); });
        c_telefono.addEventListener('blur', function() { validatePhone(this); });
        c_password.addEventListener('blur', function() { validatePassword(this); });
        c_password2.addEventListener('blur', function() { validatePasswordConfirm(c_password, this); });
    }

    // --- Formulario EDITAR ---
    const e_nombre = document.getElementById('e_nombre');
    const e_email = document.getElementById('e_email');
    const e_telefono = document.getElementById('e_telefono');
    
    if (e_nombre) {
        e_telefono.addEventListener('input', function() { formatPhone(this); });
        e_nombre.addEventListener('input', function() { validateNameInput(this); });
        e_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
        e_email.addEventListener('blur', function() { validateEmail(this); });
        e_telefono.addEventListener('blur', function() { validatePhone(this); });
    }

    // Manejo de tecla Escape para cerrar modales
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal[style*="display: block"]');
            if (activeModal) {
                if (activeModal.id === 'createEmpleadoModal') closeCreateEmpleadoModal();
                else if (activeModal.id === 'editEmpleadoModal') closeEditEmpleadoModal();
                else if (activeModal.id === 'customAlert') closeCustomAlert();
            }
        }
    });
});
</script>
{% endblock %}
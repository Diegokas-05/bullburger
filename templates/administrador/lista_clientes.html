{% extends 'base.html' %}
{% block title %}Lista de Clientes{% endblock %}

{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/listas-Usuarios.css' %}">

<div class="clientes-container">
    <div class="clientes-header">
        <h2>Lista de Clientes</h2>
        <div class="buscador">
            <form method="GET">
                <input type="text" name="buscar" placeholder="Buscar por nombre o correo" value="{{ request.GET.buscar }}">
                <button type="submit">Buscar</button>
            </form>
            <button class="btn-crear" onclick="openCreateClienteModal()">Crear</button>
        </div>
    </div>

    <table class="tabla-clientes" id="tabla-clientes">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>TelÃ©fono</th>
                <th>DirecciÃ³n</th>
                <th>Creado en</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>

            {% for cliente in clientes %}
            <tr class="data-row" data-id="{{ cliente.id }}">
                <td>{{ cliente.id }}</td>
                <td class="c-nombre">{{ cliente.nombre }}</td>
                <td class="c-email">{{ cliente.email }}</td>
                <td class="c-telefono">{{ cliente.telefono|default:"-" }}</td>
                <td class="c-direccion">{{ cliente.direccion|default:"-" }}</td>
                <td>{{ cliente.creado_en|date:"d/m/Y H:i" }}</td>
                <td>
                    <div class="action-buttons-small">
                        <button class="btn-action btn-edit" onclick="openEditClienteModal({{ cliente.id }})">âœï¸</button>
                        <button class="btn-action btn-delete" onclick="confirmDeleteCliente({{ cliente.id }}, '{{ cliente.nombre|escapejs }}')">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="sin-resultados">No se encontraron clientes.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<div id="createClienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Crear Cliente</h2>
            <span class="close" onclick="closeCreateClienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createClienteForm" onsubmit="return submitCreateCliente(event)" novalidate>
                {% csrf_token %}
                <div class="form-group">
                    <label for="c_nombre">Nombre *</label>
                    <input type="text" id="c_nombre" required class="form-control">
                    <div class="error-message" id="c_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="c_email">Correo *</label>
                    <input type="email" id="c_email" required class="form-control">
                    <div class="error-message" id="c_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="c_telefono">TelÃ©fono</label>
                    <input type="text" id="c_telefono" class="form-control">
                    <div class="error-message" id="c_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="c_direccion">DirecciÃ³n</label>
                    <input type="text" id="c_direccion" class="form-control">
                </div>
                <div class="form-group">
                    <label for="c_password">ContraseÃ±a *</label>
                    <input type="password" id="c_password" required class="form-control">
                    <div class="error-message" id="c_passwordError"></div>
                </div>
                <div class="form-group">
                    <label for="c_password2">Confirmar contraseÃ±a *</label>
                    <input type="password" id="c_password2" required class="form-control">
                    <div class="error-message" id="c_password2Error"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeCreateClienteModal()">Cancelar</button>
            <button type="submit" form="createClienteForm" class="btn-save">Crear</button>
        </div>
    </div>
</div>


<div id="editClienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Cliente</h2>
            <span class="close" onclick="closeEditClienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editClienteForm" onsubmit="return submitEditCliente(event)" novalidate>
                {% csrf_token %}
                <input type="hidden" id="e_id">
                <div class="form-group">
                    <label for="e_nombre">Nombre *</label>
                    <input type="text" id="e_nombre" required class="form-control">
                    <div class="error-message" id="e_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="e_email">Correo *</label>
                    <input type="email" id="e_email" required class="form-control">
                    <div class="error-message" id="e_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="e_telefono">TelÃ©fono</label>
                    <input type="text" id="e_telefono" class="form-control">
                    <div class="error-message" id="e_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="e_direccion">DirecciÃ³n</label>
                    <input type="text" id="e_direccion" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeEditClienteModal()">Cancelar</button>
                <button type="submit" form="editClienteForm" class="btn-save">Actualizar</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="alertTitle">Alerta</h2>
                <span class="close" onclick="closeCustomAlert()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="alertMessage"></p>
                <div class="form-actions" style="justify-content:center;">
                    <button type="button" class="btn-cancel" onclick="closeCustomAlert()">Cancelar</button>
                    <button type="button" class="btn-save" id="alertConfirmBtn">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

<script>
/* ===== Funciones de ValidaciÃ³n (Copiadas de Admin) ===== */
function showError(input, message) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.add('error-field');
Â  Â  Â  Â  errorElement.textContent = message;
Â  Â  Â  Â  errorElement.style.display = 'block';
Â  Â  }
}

function hideError(input) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.remove('error-field');
        errorElement.style.display = 'none';
    }
}

function clearAllErrors(formElement) {
    const errors = formElement.querySelectorAll('.error-message');
    const errorInputs = formElement.querySelectorAll('.error-field');
    errors.forEach(error => {
        error.textContent = '';
        error.style.display = 'none';
    });
    errorInputs.forEach(input => input.classList.remove('error-field'));
}

function formatPhone(input) {
Â  Â  let value = input.value.replace(/\D/g, '');
Â  Â  if (value.length > 4) {
Â  Â  Â  Â  value = value.substring(0, 4) + '-' + value.substring(4, 8);
Â  Â  }
Â  Â  input.value = value;
}

function validateNameInput(input) {
Â  Â  input.value = input.value.replace(/[^A-Za-zÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]/g, '');
}

function validateLettersOnly(input) {
Â  Â  const value = input.value.trim();
Â  Â  if (!value) {
Â  Â  Â  Â  showError(input, 'Este campo es obligatorio');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  const lettersOnly = /^[A-Za-zÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÃ‘Ã±\s\-.,!Â¡Â¿?()&]+$/;
Â  Â  if (!lettersOnly.test(value)) {
Â  Â  Â  Â  showError(input, 'Solo se permiten letras y espacios');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  if (value.length < 2) {
Â  Â  Â  Â  showError(input, 'El nombre debe tener al menos 2 caracteres');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  hideError(input);
Â  Â  return true;
}

function validateEmail(input) {
Â  Â  const value = input.value.trim();
Â  Â  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
Â  Â  if (!value) {
Â  Â  Â  Â  showError(input, 'El email es obligatorio');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  if (!emailRegex.test(value)) {
Â  Â  Â  Â  showError(input, 'Por favor ingresa un email vÃ¡lido');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  hideError(input);
Â  Â  return true;
}

function validatePhone(input) {
Â  Â  const value = input.value.trim();
Â  Â  if (!value) {
Â  Â  Â  Â  hideError(input);
Â  Â  Â  Â  return true;
Â  Â  }
Â  Â  const phoneRegex = /^\d{4}-\d{4}$/;
Â  Â  if (!phoneRegex.test(value)) {
Â  Â  Â  Â  showError(input, 'Formato invÃ¡lido. Usar formato: 1234-5678');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  hideError(input);
Â  Â  return true;
}

function validatePassword(input) {
Â  Â  const value = input.value;
Â  Â  if (!value) {
Â  Â  Â  Â  showError(input, 'La contraseÃ±a es obligatoria');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  if (value.length < 8) {
Â  Â  Â  Â  showError(input, 'La contraseÃ±a debe tener al menos 8 caracteres');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  hideError(input);
Â  Â  return true;
}

function validatePasswordConfirm(passwordInput, confirmInput) {
Â  Â  const passValue = passwordInput.value;
Â  Â  const confirmValue = confirmInput.value;
Â  Â  if (!confirmValue) {
Â  Â  Â  Â  showError(confirmInput, 'Por favor confirma tu contraseÃ±a');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  if (confirmValue !== passValue) {
Â  Â  Â  Â  showError(confirmInput, 'Las contraseÃ±as no coinciden');
Â  Â  Â  Â  return false;
Â  Â  }
Â  Â  hideError(confirmInput);
Â  Â  return true;
}

/* ===== Funciones "Maestras" para Modales (Adaptadas) ===== */

// Valida el formulario de CREAR (con contraseÃ±a)
function validateCreateForm() {
Â  Â  const nombre = document.getElementById('c_nombre');
Â  Â  const email = document.getElementById('c_email');
Â  Â  const telefono = document.getElementById('c_telefono');
Â  Â  const password = document.getElementById('c_password');
Â  Â  const password2 = document.getElementById('c_password2');
Â  Â  
Â  Â  let isValid = true;
Â  Â  if (!validateLettersOnly(nombre)) isValid = false;
Â  Â  if (!validateEmail(email)) isValid = false;
Â  Â  if (!validatePhone(telefono)) isValid = false;
Â  Â  if (!validatePassword(password)) isValid = false;
Â  Â  if (!validatePasswordConfirm(password, password2)) isValid = false;
Â  Â  
Â  Â  return isValid;
}

// Valida el formulario de EDITAR (SIN contraseÃ±a)
function validateEditForm() {
Â  Â  const nombre = document.getElementById('e_nombre');
Â  Â  const email = document.getElementById('e_email');
Â  Â  const telefono = document.getElementById('e_telefono');
Â  Â  
Â  Â  let isValid = true;
Â  Â  if (!validateLettersOnly(nombre)) isValid = false;
Â  Â  if (!validateEmail(email)) isValid = false;
Â  Â  if (!validatePhone(telefono)) isValid = false;
Â  Â  
Â  Â  return isValid;
}


/* ===== CSRF ===== */
function getCookie(name) {
Â  let cookieValue = null;
Â  if (document.cookie && document.cookie !== '') {
Â  Â  Â  const cookies = document.cookie.split(';');
Â  Â  Â  for (let i=0; i<cookies.length; i++) {
Â  Â  Â  Â  Â  const cookie = cookies[i].trim();
Â  Â  Â  Â  Â  if (cookie.substring(0, name.length + 1) === (name + '=')) {
Â  Â  Â  Â  Â  Â  Â  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  }
Â  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ===== Helpers Alert ===== */
function showCustomAlert(title, message, confirmCallback = null) {
Â  document.getElementById('alertTitle').textContent = title;
Â  document.getElementById('alertMessage').textContent = message;
Â  document.getElementById('customAlert').style.display = 'block';
Â  const confirmBtn = document.getElementById('alertConfirmBtn');
Â  if (confirmCallback) {
Â  Â  Â  confirmBtn.onclick = function() { confirmCallback(); closeCustomAlert(); };
Â  } else {
Â  Â  Â  confirmBtn.onclick = closeCustomAlert;
Â  }
}
function closeCustomAlert() {
Â  document.getElementById('customAlert').style.display = 'none';
}

/* ===== Modal Crear (AÃ‘ADIDO) ===== */
function openCreateClienteModal() {
Â  document.getElementById('createClienteModal').style.display = 'block';
}

function closeCreateClienteModal() {
Â  document.getElementById('createClienteModal').style.display = 'none';
Â  document.getElementById('createClienteForm').reset();
Â  clearAllErrors(document.getElementById('createClienteForm'));
}

function submitCreateCliente(e) {
Â  e.preventDefault();
Â  clearAllErrors(document.getElementById('createClienteForm'));
Â  
Â  if (!validateCreateForm()) {
Â  Â  Â  showCustomAlert('Error de ValidaciÃ³n', 'Por favor corrige los errores en el formulario.');
Â  Â  Â  return false;
Â  }

Â  const data = {
Â  Â  nombre: document.getElementById('c_nombre').value,
Â  Â  email: document.getElementById('c_email').value,
Â  Â  telefono: document.getElementById('c_telefono').value,
Â  Â  direccion: document.getElementById('c_direccion').value,
Â  Â  password: document.getElementById('c_password').value,
Â  Â  password2: document.getElementById('c_password2').value
Â  };

  // AsegÃºrate de que esta URL sea correcta para tu proyecto
Â  fetch('/clientes/crear/', { 
Â  Â  method: 'POST',
Â  Â  headers: {
Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  'X-CSRFToken': csrftoken,
Â  Â  Â  'X-Requested-With': 'XMLHttpRequest'
Â  Â  },
Â  Â  body: JSON.stringify(data)
Â  })
Â  .then(r => r.json())
Â  .then(json => {
Â  Â  if (json.ok) {
Â  Â  Â  closeCreateClienteModal();
Â  Â  Â  location.reload(); // Recarga la pÃ¡gina para ver al nuevo cliente
Â  Â  } else {
Â  Â  Â  if (json.errors) {
Â  Â  Â  Â  Â  if (json.errors.email) {
Â  Â  Â  Â  Â  Â  Â  showError(document.getElementById('c_email'), json.errors.email[0]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (json.errors.password) {
Â  Â  Â  Â  Â  Â  Â  showError(document.getElementById('c_password'), json.errors.password[0]);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  showCustomAlert('Error', json.errors.non_field_errors || 'Revisa los campos del formulario.');
Â  Â  }
Â  })
Â  .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
Â  return false;
}

/* ===== Modal Editar (ACTUALIZADO) ===== */
function openEditClienteModal(id) {
Â  fetch(`/clientes/editar/${id}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  // Usa los IDs del modal de ediciÃ³n (e_*)
Â  Â  Â  document.getElementById('e_id').value = data.id;
Â  Â  Â  document.getElementById('e_nombre').value = data.nombre || '';
Â  Â  Â  document.getElementById('e_email').value = data.email || '';
Â  Â  Â  document.getElementById('e_telefono').value = data.telefono || '';
Â  Â  Â  document.getElementById('e_direccion').value = data.direccion || '';
Â  Â  Â  document.getElementById('editClienteModal').style.display = 'block';
Â  Â  });
}
function closeEditClienteModal() {
Â  document.getElementById('editClienteModal').style.display = 'none';
  clearAllErrors(document.getElementById('editClienteForm'));
}

function submitEditCliente(e) {
Â  e.preventDefault();
Â  clearAllErrors(document.getElementById('editClienteForm'));
Â  
Â  if (!validateEditForm()) {
Â  Â  Â  showCustomAlert('Error de ValidaciÃ³n', 'Por favor corrige los errores en el formulario.');
Â  Â  Â  return false;
Â  }

Â  const id = document.getElementById('e_id').value;
Â  const data = {
Â  Â  nombre: document.getElementById('e_nombre').value,
Â  Â  email: document.getElementById('e_email').value,
Â  Â  telefono: document.getElementById('e_telefono').value,
Â  Â  direccion: document.getElementById('e_direccion').value
Â  };
  // No se envÃ­an contraseÃ±as al editar un cliente

Â  fetch(`/clientes/editar/${id}/`, {
Â  Â  method: 'POST',
Â  Â  headers: {
Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  'X-CSRFToken': csrftoken,
Â  Â  Â  'X-Requested-With': 'XMLHttpRequest'
Â  Â  },
Â  Â  body: JSON.stringify(data)
Â  })
Â  .then(r => r.json())
.then(json => { // Cambiado 'resp' a 'json' para consistencia
Â  Â  if (json.success) { // Tu lÃ³gica original usaba 'success'
Â  Â  Â  // Actualizar fila sin recargar
Â  Â  Â  const fila = document.querySelector(`tr[data-id='${id}']`);
Â  Â  Â  fila.querySelector('.c-nombre').textContent = data.nombre;
Â  Â  Â  fila.querySelector('.c-email').textContent = data.email;
Â  Â  Â  fila.querySelector('.c-telefono').textContent = data.telefono || '-';
Â  Â  Â  fila.querySelector('.c-direccion').textContent = data.direccion || '-';
Â  Â  Â  closeEditClienteModal();
Â  Â  Â  showCustomAlert('Ã‰xito', 'Cliente actualizado correctamente.');
Â  Â  } else {
Â  Â  Â  if (json.errors) {
Â  Â  Â  Â  Â  if (json.errors.email) {
Â  Â  Â  Â  Â  Â  Â  showError(document.getElementById('e_email'), json.errors.email[0]);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  showCustomAlert('Error', json.error || json.errors.non_field_errors || 'No se pudo actualizar.');
Â  Â  }
Â  })
Â  .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
Â  return false;
}

/* ===== Eliminar (ACTUALIZADO) ===== */
function confirmDeleteCliente(id, nombre) {
Â  showCustomAlert('Confirmar EliminaciÃ³n', `Â¿Seguro que deseas eliminar al cliente "${nombre}"?`, function () {
Â  Â  fetch(`/clientes/eliminar/${id}/`, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
Â  Â  })
Â  Â  .then(res => res.json())
Â  Â  .then(resp => {
Â  Â  Â  if (resp.success) { // Tu lÃ³gica original usaba 'success'
Â  Â  Â  Â  document.querySelector(`tr[data-id='${id}']`).remove();
Â  Â  Â  Â  showCustomAlert('Ã‰xito', 'Cliente eliminado correctamente.');
Â  Â  Â  } else {
Â  Â  Â  Â  showCustomAlert('Error', resp.error || 'No se pudo eliminar.');
Â  Â  Â  }
Â  Â  })
Â  Â  .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
Â  });
}

/* ===== Listeners (AÃ‘ADIDOS) ===== */
document.addEventListener('DOMContentLoaded', function() {
Â  Â  
Â  Â  // --- Formulario CREAR ---
Â  Â  const c_nombre = document.getElementById('c_nombre');
Â  Â  const c_email = document.getElementById('c_email');
Â  Â  const c_telefono = document.getElementById('c_telefono');
Â  Â  const c_password = document.getElementById('c_password');
Â  Â  const c_password2 = document.getElementById('c_password2');

Â  Â  if(c_nombre) { // AÃ±adido chequeo por si el modal no existe
Â  Â  Â  c_telefono.addEventListener('input', function() { formatPhone(this); });
Â  Â  Â  c_nombre.addEventListener('input', function() { validateNameInput(this); });
Â  Â  Â  c_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
Â  Â  Â  c_email.addEventListener('blur', function() { validateEmail(this); });
Â  Â  Â  c_telefono.addEventListener('blur', function() { validatePhone(this); });
Â  Â  Â  c_password.addEventListener('blur', function() { validatePassword(this); });
Â  Â  Â  c_password2.addEventListener('blur', function() { validatePasswordConfirm(c_password, this); });
Â  Â  }

Â  Â  // --- Formulario EDITAR ---
Â  Â  const e_nombre = document.getElementById('e_nombre');
Â  Â  const e_email = document.getElementById('e_email');
Â  Â  const e_telefono = document.getElementById('e_telefono');
Â  Â  
Â  Â  if(e_nombre) { // AÃ±adido chequeo por si el modal no existe
Â  Â  Â  e_telefono.addEventListener('input', function() { formatPhone(this); });
Â  Â  Â  e_nombre.addEventListener('input', function() { validateNameInput(this); });
Â  Â  Â  e_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
Â  Â  Â  e_email.addEventListener('blur', function() { validateEmail(this); });
Â  Â  Â  e_telefono.addEventListener('blur', function() { validatePhone(this); });
Â  Â  }
});
</script>
{% endblock %}
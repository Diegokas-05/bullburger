{% extends 'base.html' %}
{% block title %}Lista de Clientes{% endblock %}
{% load static %}

{% block content %}
<!-- SweetAlert2 es necesario para esta vista. Aseg√∫rate de incluir CSS y JS en base.html -->
<link rel="stylesheet" href="{% static 'css/listas-usuarios.css' %}">

<div class="clientes-container">
    <div class="clientes-header">
        <h2>Lista de Clientes</h2>
        <div class="buscador">
            <form method="GET">
                <input type="text" name="buscar" placeholder="Buscar por nombre o correo" value="{{ request.GET.buscar }}">
                <button type="submit">Buscar</button>
            </form>
            <button class="btn-crear" onclick="openCreateClienteModal()">Crear</button>
        </div>
    </div>

    <div class="table-responsive">
    <table class="tabla-clientes" id="tabla-clientes">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Tel√©fono</th>
                <th>Direcci√≥n</th>
                <th>Creado en</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for cliente in clientes %}
            <tr class="data-row" data-id="{{ cliente.id }}">
                <td>{{ cliente.id }}</td>
                <td class="c-nombre">{{ cliente.nombre }}</td>
                <td class="c-email">{{ cliente.email }}</td>
                <td class="c-telefono">{{ cliente.telefono|default:"-" }}</td>
                <td class="c-direccion">{{ cliente.direccion|default:"-" }}</td>
                
                <td class="c-creado-en">{{ cliente.creado_en|date:"d/m/Y" }}</td> 
                
                <td> 
                    <div class="action-buttons-small">
                         <button class="btn-action btn-edit" onclick="openEditClienteModal({{ cliente.id }})">‚úèÔ∏è</button>
                         <button class="btn-action btn-delete" onclick="confirmDeleteCliente({{ cliente.id }}, '{{ cliente.nombre|escapejs }}')">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="sin-resultados">No se encontraron clientes.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<div id="createClienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Crear Cliente</h2>
            <span class="close" onclick="closeCreateClienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createClienteForm" onsubmit="return submitCreateCliente(event)" novalidate>
                {% csrf_token %}
                <div class="form-group">
                    <label for="c_nombre">Nombre *</label>
                    <input type="text" id="c_nombre" required class="form-control">
                    <div class="error-message" id="c_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="c_email">Correo *</label>
                    <input type="email" id="c_email" required class="form-control">
                    <div class="error-message" id="c_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="c_telefono">Tel√©fono</label>
                    <input type="text" id="c_telefono" class="form-control">
                    <div class="error-message" id="c_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="c_direccion">Direcci√≥n</label>
                    <input type="text" id="c_direccion" class="form-control">
                </div>
                <div class="form-group">
                    <label for="c_password">Contrase√±a *</label>
                    <input type="password" id="c_password" required class="form-control">
                    <div class="error-message" id="c_passwordError"></div>
                </div>
                <div class="form-group">
                    <label for="c_password2">Confirmar contrase√±a *</label>
                    <input type="password" id="c_password2" required class="form-control">
                    <div class="error-message" id="c_password2Error"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeCreateClienteModal()">Cancelar</button>
            <button type="submit" form="createClienteForm" class="btn-save">Crear</button>
        </div>
    </div>
</div>

<div id="editClienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Cliente</h2>
            <span class="close" onclick="closeEditClienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editClienteForm" onsubmit="return submitEditCliente(event)" novalidate>
                {% csrf_token %}
                <input type="hidden" id="e_id">
                <div class="form-group">
                    <label for="e_nombre">Nombre *</label>
                    <input type="text" id="e_nombre" required class="form-control">
                    <div class="error-message" id="e_nombreError"></div>
                </div>
                <div class="form-group">
                    <label for="e_email">Correo *</label>
                    <input type="email" id="e_email" required class="form-control">
                    <div class="error-message" id="e_emailError"></div>
                </div>
                <div class="form-group">
                    <label for="e_telefono">Tel√©fono</label>
                    <input type="text" id="e_telefono" class="form-control">
                    <div class="error-message" id="e_telefonoError"></div>
                </div>
                <div class="form-group">
                    <label for="e_direccion">Direcci√≥n</label>
                    <input type="text" id="e_direccion" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeEditClienteModal()">Cancelar</button>
            <button type="submit" form="editClienteForm" class="btn-save">Actualizar</button>
        </div>
    </div>
</div>

<!-- üõë ELIMINAMOS #customAlert Y LO REEMPLAZAMOS CON Swal.fire() üõë -->

<script>
/* ===== Funciones de Validaci√≥n (Se mantienen para los modales de Crear/Editar) ===== */
function showError(input, message) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.add('error-field');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

function hideError(input) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.remove('error-field');
        errorElement.style.display = 'none';
    }
}

function clearAllErrors(formElement) {
    const errors = formElement.querySelectorAll('.error-message');
    const errorInputs = formElement.querySelectorAll('.error-field');
    errors.forEach(error => {
        error.textContent = '';
        error.style.display = 'none';
    });
    errorInputs.forEach(input => input.classList.remove('error-field'));
}

function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 4) {
        value = value.substring(0, 4) + '-' + value.substring(4, 8);
    }
    input.value = value;
}

function validateNameInput(input) {
    input.value = input.value.replace(/[^A-Za-z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
}

function validateLettersOnly(input) {
    const value = input.value.trim();
    if (!value) {
        showError(input, 'Este campo es obligatorio');
        return false;
    }
    const lettersOnly = /^[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s\-.,!¬°¬ø?()&]+$/;
    if (!lettersOnly.test(value)) {
        showError(input, 'Solo se permiten letras y espacios');
        return false;
    }
    if (value.length < 2) {
        showError(input, 'El nombre debe tener al menos 2 caracteres');
        return false;
    }
    hideError(input);
    return true;
}

function validateEmail(input) {
    const value = input.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!value) {
        showError(input, 'El email es obligatorio');
        return false;
    }
    if (!emailRegex.test(value)) {
        showError(input, 'Por favor ingresa un email v√°lido');
        return false;
    }
    hideError(input);
    return true;
}

function validatePhone(input) {
    const value = input.value.trim();
    if (!value) {
        hideError(input);
        return true;
    }
    const phoneRegex = /^\d{4}-\d{4}$/;
    if (!phoneRegex.test(value)) {
        showError(input, 'Formato inv√°lido. Usar formato: 1234-5678');
        return false;
    }
    hideError(input);
    return true;
}

function validatePassword(input) {
    const value = input.value;
    if (!value) {
        showError(input, 'La contrase√±a es obligatoria');
        return false;
    }
    if (value.length < 8) {
        showError(input, 'La contrase√±a debe tener al menos 8 caracteres');
        return false;
    }
    hideError(input);
    return true;
}

function validatePasswordConfirm(passwordInput, confirmInput) {
    const passValue = passwordInput.value;
    const confirmValue = confirmInput.value;
    if (!confirmValue) {
        showError(confirmInput, 'Por favor confirma tu contrase√±a');
        return false;
    }
    if (confirmValue !== passValue) {
        showError(confirmInput, 'Las contrase√±as no coinciden');
        return false;
    }
    hideError(confirmInput);
    return true;
}

/* ===== Funciones "Maestras" para Modales ===== */

function validateCreateForm() {
    const nombre = document.getElementById('c_nombre');
    const email = document.getElementById('c_email');
    const telefono = document.getElementById('c_telefono');
    const password = document.getElementById('c_password');
    const password2 = document.getElementById('c_password2');
    
    let isValid = true;
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateEmail(email)) isValid = false;
    if (!validatePhone(telefono)) isValid = false;
    if (!validatePassword(password)) isValid = false;
    if (!validatePasswordConfirm(password, password2)) isValid = false;
    
    return isValid;
}

function validateEditForm() {
    const nombre = document.getElementById('e_nombre');
    const email = document.getElementById('e_email');
    const telefono = document.getElementById('e_telefono');
    
    let isValid = true;
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateEmail(email)) isValid = false;
    if (!validatePhone(telefono)) isValid = false;
    
    return isValid;
}

/* ===== CSRF ===== */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ===== Modal Crear ===== */
function openCreateClienteModal() {
    document.getElementById('createClienteModal').style.display = 'block';
}

function closeCreateClienteModal() {
    document.getElementById('createClienteModal').style.display = 'none';
    document.getElementById('createClienteForm').reset();
    clearAllErrors(document.getElementById('createClienteForm'));
}

function submitCreateCliente(e) {
    e.preventDefault();
    clearAllErrors(document.getElementById('createClienteForm'));
    
    if (!validateCreateForm()) {
        Swal.fire('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.', 'warning');
        return false;
    }

    const data = {
        nombre: document.getElementById('c_nombre').value,
        email: document.getElementById('c_email').value,
        telefono: document.getElementById('c_telefono').value,
        direccion: document.getElementById('c_direccion').value,
        password: document.getElementById('c_password').value,
        password2: document.getElementById('c_password2').value
    };

    fetch('/clientes/crear/', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(json => {
        if (json.ok) {
            closeCreateClienteModal();
            // SweetAlert de √©xito antes de recargar
            Swal.fire({
                title: '¬°Cliente Creado!',
                text: 'La cuenta ha sido registrada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        } else {
            if (json.errors) {
                if (json.errors.email) {
                    showError(document.getElementById('c_email'), json.errors.email[0]);
                }
                if (json.errors.password) {
                    showError(document.getElementById('c_password'), json.errors.password[0]);
                }
            }
            Swal.fire('Error', json.errors.non_field_errors || 'Revisa los campos del formulario.', 'error');
        }
    })
    .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
    return false;
}

/* ===== Modal Editar ===== */
function openEditClienteModal(id) {
    fetch(`/clientes/editar/${id}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
        .then(res => res.json())
        .then(data => {
            document.getElementById('e_id').value = data.id;
            document.getElementById('e_nombre').value = data.nombre || '';
            document.getElementById('e_email').value = data.email || '';
            document.getElementById('e_telefono').value = data.telefono || '';
            document.getElementById('e_direccion').value = data.direccion || '';
            
            clearAllErrors(document.getElementById('editClienteForm')); // Limpiar errores al abrir
            document.getElementById('editClienteModal').style.display = 'block';
        })
        .catch(() => Swal.fire('Error', 'No se pudo cargar la informaci√≥n del cliente.', 'error'));
}
function closeEditClienteModal() {
    document.getElementById('editClienteModal').style.display = 'none';
    clearAllErrors(document.getElementById('editClienteForm'));
}

function submitEditCliente(e) {
    e.preventDefault();
    clearAllErrors(document.getElementById('editClienteForm'));
    
    if (!validateEditForm()) {
        Swal.fire('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.', 'warning');
        return false;
    }

    const id = document.getElementById('e_id').value;
    const data = {
        nombre: document.getElementById('e_nombre').value,
        email: document.getElementById('e_email').value,
        telefono: document.getElementById('e_telefono').value,
        direccion: document.getElementById('e_direccion').value
    };

    fetch(`/clientes/editar/${id}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(json => {
        if (json.success) {
            // Actualizaci√≥n visual sin recargar
            const fila = document.querySelector(`tr[data-id='${id}']`);
            fila.querySelector('.c-nombre').textContent = data.nombre;
            fila.querySelector('.c-email').textContent = data.email;
            fila.querySelector('.c-telefono').textContent = data.telefono || '-';
            fila.querySelector('.c-direccion').textContent = data.direccion || '-';
            
            closeEditClienteModal();
            Swal.fire('√âxito', 'Cliente actualizado correctamente.', 'success');
        } else {
            if (json.errors) {
                if (json.errors.email) {
                    showError(document.getElementById('e_email'), json.errors.email[0]);
                }
            }
            Swal.fire('Error', json.error || json.errors.non_field_errors || 'No se pudo actualizar.', 'error');
        }
    })
    .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
    return false;
}

/* ===== Eliminar con SweetAlert2 ===== */
function confirmDeleteCliente(id, nombre) {
    Swal.fire({
        title: 'Confirmar Eliminaci√≥n',
        html: `¬øEst√°s seguro de que quieres eliminar al cliente "<strong>${nombre}</strong>"? <br>Esta acci√≥n no se puede deshacer.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Aceptar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true, 
        confirmButtonColor: '#d32f2f'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/clientes/eliminar/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    document.querySelector(`tr[data-id='${id}']`).remove();
                    Swal.fire('¬°Eliminado!', 'Cliente eliminado correctamente.', 'success');
                } else {
                    Swal.fire('Error', resp.error || 'No se pudo eliminar al cliente.', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
        }
    });
}

/* ===== Listeners ===== */
document.addEventListener('DOMContentLoaded', function() {
    // --- Formulario CREAR ---
    const c_nombre = document.getElementById('c_nombre');
    const c_email = document.getElementById('c_email');
    const c_telefono = document.getElementById('c_telefono');
    const c_password = document.getElementById('c_password');
    const c_password2 = document.getElementById('c_password2');

    if(c_nombre) {
      c_telefono.addEventListener('input', function() { formatPhone(this); });
      c_nombre.addEventListener('input', function() { validateNameInput(this); });
      c_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
      c_email.addEventListener('blur', function() { validateEmail(this); });
      c_telefono.addEventListener('blur', function() { validatePhone(this); });
      c_password.addEventListener('blur', function() { validatePassword(this); });
      c_password2.addEventListener('blur', function() { validatePasswordConfirm(c_password, this); });
    }

    // --- Formulario EDITAR ---
    const e_nombre = document.getElementById('e_nombre');
    const e_email = document.getElementById('e_email');
    const e_telefono = document.getElementById('e_telefono');
    
    if(e_nombre) {
      e_telefono.addEventListener('input', function() { formatPhone(this); });
      e_nombre.addEventListener('input', function() { validateNameInput(this); });
      e_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
      e_email.addEventListener('blur', function() { validateEmail(this); });
      e_telefono.addEventListener('blur', function() { validatePhone(this); });
    }
});
</script>
{% endblock %}
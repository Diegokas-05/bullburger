{% extends 'base.html' %}
{% block title %}Lista de Administradores{% endblock %}

{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/listas-Usuarios.css' %}">

<div class="clientes-container">
  <div class="clientes-header">
    <h2>Lista de Administradores</h2>

    <div class="buscador">
      <form method="GET">
        <input type="text" name="buscar" placeholder="Buscar por nombre o correo" value="{{ request.GET.buscar }}">
        <button type="submit">Buscar</button>
      </form>
      <button class="btn-crear" onclick="openCreateAdminModal()">Crear</button>
    </div>
  </div>

  <table class="tabla-clientes" id="tabla-admins">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Tel√©fono</th>
        <th>Direcci√≥n</th>
        <th>Creado en</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for a in admins %}
      <tr class="data-row" data-id="{{ a.id }}">
        <td>{{ a.id }}</td>
        <td class="a-nombre">{{ a.nombre }}</td>
        <td class="a-email">{{ a.email }}</td>
        <td class="a-telefono">{{ a.telefono|default:"-" }}</td>
        <td class="a-direccion">{{ a.direccion|default:"-" }}</td>
        <td>{{ a.creado_en|date:"d/m/Y H:i" }}</td>
        <td>
          <div class="action-buttons-small">
            <button class="btn-action btn-edit" onclick="openEditAdminModal({{ a.id }})">‚úèÔ∏è</button>
            <button class="btn-action btn-delete" onclick="confirmDeleteAdmin({{ a.id }}, '{{ a.nombre|escapejs }}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="sin-resultados">No se encontraron administradores.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- === Modal CREAR Administrador === -->
<div id="createAdminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Crear Administrador</h2>
      <span class="close" onclick="closeCreateAdminModal()">&times;</span>
    </div>

    <div class="modal-body">
      <form id="createAdminForm" onsubmit="return submitCreateAdmin(event)">
        {% csrf_token %}

        <div class="form-group">
          <label for="c_nombre">Nombre *</label>
          <input type="text" id="c_nombre" required class="form-control">
        </div>

        <div class="form-group">
          <label for="c_email">Correo *</label>
          <input type="email" id="c_email" required class="form-control">
          <div class="error-message" id="c_emailError"></div>
        </div>

        <div class="form-group">
          <label for="c_telefono">Tel√©fono</label>
          <input type="text" id="c_telefono" class="form-control">
        </div>

        <div class="form-group">
          <label for="c_direccion">Direcci√≥n</label>
          <input type="text" id="c_direccion" class="form-control">
        </div>

        <div class="form-group">
          <label for="c_password">Contrase√±a *</label>
          <input type="password" id="c_password" required class="form-control">
        </div>

        <div class="form-group">
          <label for="c_password2">Confirmar contrase√±a *</label>
          <input type="password" id="c_password2" required class="form-control">
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeCreateAdminModal()">Cancelar</button>
      <button type="submit" form="createAdminForm" class="btn-save">Crear</button>
    </div>
  </div>
</div>


<!-- === Modal EDITAR Administrador === -->
<div id="editAdminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Editar Administrador</h2>
      <span class="close" onclick="closeEditAdminModal()">&times;</span>
    </div>

    <!-- SOLO el contenido scrollea -->
    <div class="modal-body">
      <form id="editAdminForm" onsubmit="return submitEditAdmin(event)">
        {% csrf_token %}
        <input type="hidden" id="e_id">

        <div class="form-group">
          <label for="e_nombre">Nombre *</label>
          <input type="text" id="e_nombre" required class="form-control">
        </div>

        <div class="form-group">
          <label for="e_email">Correo *</label>
          <input type="email" id="e_email" required class="form-control">
          <div class="error-message" id="e_emailError"></div>
        </div>

        <div class="form-group">
          <label for="e_telefono">Tel√©fono</label>
          <input type="text" id="e_telefono" class="form-control">
        </div>

        <div class="form-group">
          <label for="e_direccion">Direcci√≥n</label>
          <input type="text" id="e_direccion" class="form-control">
        </div>

        <div class="form-group">
          <label for="e_password">Nueva contrase√±a (opcional)</label>
          <input type="password" id="e_password" class="form-control">
        </div>

        <div class="form-group">
          <label for="e_password2">Confirmar nueva contrase√±a</label>
          <input type="password" id="e_password2" class="form-control">
        </div>
      </form>
    </div>

    <!-- BOTONERA fuera del body -->
    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeEditAdminModal()">Cancelar</button>
      <button type="submit" form="editAdminForm" class="btn-save">Actualizar</button>
    </div>
  </div>
</div>


<!-- Modal de alerta (reutilizado) -->
<div id="customAlert" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2 id="alertTitle">Alerta</h2>
      <span class="close" onclick="closeCustomAlert()">&times;</span>
    </div>
    <div class="modal-body">
      <p id="alertMessage"></p>
      <div class="form-actions" style="justify-content:center;">
        <button type="button" class="btn-cancel" onclick="closeCustomAlert()">Cancelar</button>
        <button type="button" class="btn-save" id="alertConfirmBtn">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== CSRF ===== */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0; i<cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ===== Helpers Alert ===== */
function showCustomAlert(title, message, confirmCallback = null) {
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertMessage').textContent = message;
  document.getElementById('customAlert').style.display = 'block';
  const confirmBtn = document.getElementById('alertConfirmBtn');
  if (confirmCallback) {
      confirmBtn.onclick = function() { confirmCallback(); closeCustomAlert(); };
  } else {
      confirmBtn.onclick = closeCustomAlert;
  }
}
function closeCustomAlert() {
  document.getElementById('customAlert').style.display = 'none';
}

/* ===== Modal Crear ===== */
function openCreateAdminModal() {
  document.getElementById('createAdminModal').style.display = 'block';
}
function closeCreateAdminModal() {
  document.getElementById('createAdminModal').style.display = 'none';
}
function submitCreateAdmin(e) {
  e.preventDefault();
  const data = {
    nombre: document.getElementById('c_nombre').value,
    email: document.getElementById('c_email').value,
    telefono: document.getElementById('c_telefono').value,
    direccion: document.getElementById('c_direccion').value,
    password: document.getElementById('c_password').value,
    password2: document.getElementById('c_password2').value
    // el rol se fuerza en la view a 'Administrador'
  };

  fetch('/administradores/crear/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(json => {
    if (json.ok) {
      closeCreateAdminModal();
      location.reload();
    } else {
      const emailErr = (json.errors && (json.errors.email || json.errors.__all__)) || null;
      if (emailErr) {
        document.getElementById('c_emailError').style.display = 'block';
        document.getElementById('c_emailError').textContent = Array.isArray(emailErr) ? emailErr.join(', ') : emailErr;
      }
      showCustomAlert('Error', 'Revisa los campos del formulario.');
    }
  })
  .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
  return false;
}

/* ===== Modal Editar ===== */
function openEditAdminModal(id) {
  fetch(`/administradores/editar/${id}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
    .then(res => res.json())
    .then(data => {
      document.getElementById('e_id').value = data.id;
      document.getElementById('e_nombre').value = data.nombre || '';
      document.getElementById('e_email').value = data.email || '';
      document.getElementById('e_telefono').value = data.telefono || '';
      document.getElementById('e_direccion').value = data.direccion || '';
      document.getElementById('e_password').value = '';
      document.getElementById('e_password2').value = '';
      document.getElementById('editAdminModal').style.display = 'block';
    });
}
function closeEditAdminModal() {
  document.getElementById('editAdminModal').style.display = 'none';
}
function submitEditAdmin(e) {
  e.preventDefault();
  const id = document.getElementById('e_id').value;
  const data = {
    nombre: document.getElementById('e_nombre').value,
    email: document.getElementById('e_email').value,
    telefono: document.getElementById('e_telefono').value,
    direccion: document.getElementById('e_direccion').value
  };

  // Enviar contrase√±a solo si han escrito algo
  const np = document.getElementById('e_password').value;
  const np2 = document.getElementById('e_password2').value;
  if (np || np2) {
    data.password = np;
    data.password2 = np2;
  }

  fetch(`/administradores/editar/${id}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(json => {
    if (json.ok) {
      // Actualizar fila sin recargar
      const fila = document.querySelector(`tr[data-id='${id}']`);
      fila.querySelector('.a-nombre').textContent = data.nombre;
      fila.querySelector('.a-email').textContent = data.email;
      fila.querySelector('.a-telefono').textContent = data.telefono || '-';
      fila.querySelector('.a-direccion').textContent = data.direccion || '-';
      closeEditAdminModal();
      showCustomAlert('√âxito', 'Administrador actualizado correctamente.');
    } else {
      const emailErr = (json.errors && (json.errors.email || json.errors.__all__)) || null;
      if (emailErr) {
        document.getElementById('e_emailError').style.display = 'block';
        document.getElementById('e_emailError').textContent = Array.isArray(emailErr) ? emailErr.join(', ') : emailErr;
      }
      showCustomAlert('Error', 'No se pudo actualizar.');
    }
  })
  .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
  return false;
}

/* ===== Eliminar ===== */
function confirmDeleteAdmin(id, nombre) {
  showCustomAlert('Confirmar Eliminaci√≥n', `¬øSeguro que deseas eliminar al administrador "${nombre}"?`, function () {
    fetch(`/administradores/eliminar/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(resp => {
      if (resp.ok) {
        document.querySelector(`tr[data-id='${id}']`).remove();
        showCustomAlert('√âxito', 'Administrador eliminado correctamente.');
      } else {
        showCustomAlert('Error', resp.msg || 'No se pudo eliminar.');
      }
    })
    .catch(() => showCustomAlert('Error', 'Error en la solicitud.'));
  });
}
</script>
{% endblock %}

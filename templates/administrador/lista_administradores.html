{% extends 'base.html' %}
{% block title %}Lista de Administradores{% endblock %}
{% load static %}

{% block content %}
<!-- SweetAlert2 es necesario para esta vista. Aseg√∫rate de incluir CSS y JS en base.html -->
<link rel="stylesheet" href="{% static 'css/listas-usuarios.css' %}">

<div class="clientes-container">
    <div class="clientes-header">
        <h2>Lista de Administradores</h2>

        <div class="buscador">
            <form method="GET">
                <input type="text" name="buscar" placeholder="Buscar por nombre o correo" value="{{ request.GET.buscar }}">
                <button type="submit">Buscar</button>
            </form>
            <button class="btn-crear" onclick="openCreateAdminModal()">Crear</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="tabla-clientes" id="tabla-admins">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Direcci√≥n</th>
                    <th>Creado en</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for a in admins %}
                <tr class="data-row" data-id="{{ a.id }}">
                    <td>{{ a.id }}</td>
                    <td class="a-nombre">{{ a.nombre }}</td>
                    <td class="a-email">{{ a.email }}</td>
                    <td class="a-telefono">{{ a.telefono|default:"-" }}</td>
                    <td class="a-direccion">{{ a.direccion|default:"-" }}</td>
                    
                    <td>{{ a.creado_en|date:"d/m/Y" }}</td>
                    
                    <td>
                        <div class="action-buttons-small">
                            <button class="btn-action btn-edit" onclick="openEditAdminModal({{ a.id }})">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="confirmDeleteAdmin({{ a.id }}, '{{ a.nombre|escapejs }}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="sin-resultados">No se encontraron administradores.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div> 
</div>

<div id="createAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Crear Administrador</h2>
            <span class="close" onclick="closeCreateAdminModal()">&times;</span>
        </div>

        <div class="modal-body">
            <form id="createAdminForm" onsubmit="return submitCreateAdmin(event)" novalidate>
                {% csrf_token %}

                <div class="form-group">
                    <label for="c_nombre">Nombre *</label>
                    <input type="text" id="c_nombre" required class="form-control">
                    <div class="error-message" id="c_nombreError"></div>
                </div>

                <div class="form-group">
                    <label for="c_email">Correo *</label>
                    <input type="email" id="c_email" required class="form-control">
                    <div class="error-message" id="c_emailError"></div>
                </div>

                <div class="form-group">
                    <label for="c_telefono">Tel√©fono</label>
                    <input type="text" id="c_telefono" class="form-control">
                    <div class="error-message" id="c_telefonoError"></div>
                </div>

                <div class="form-group">
                    <label for="c_direccion">Direcci√≥n</label>
                    <input type="text" id="c_direccion" class="form-control">
                </div>

                <div class="form-group">
                    <label for="c_password">Contrase√±a *</label>
                    <input type="password" id="c_password" required class="form-control">
                    <div class="error-message" id="c_passwordError"></div>
                </div>

                <div class="form-group">
                    <label for="c_password2">Confirmar contrase√±a *</label>
                    <input type="password" id="c_password2" required class="form-control">
                    <div class="error-message" id="c_password2Error"></div>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeCreateAdminModal()">Cancelar</button>
            <button type="submit" form="createAdminForm" class="btn-save">Crear</button>
        </div>
    </div>
</div>


<div id="editAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Administrador</h2>
            <span class="close" onclick="closeEditAdminModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <form id="editAdminForm" onsubmit="return submitEditAdmin(event)" novalidate>
                {% csrf_token %}
                <input type="hidden" id="e_id">

                <div class="form-group">
                    <label for="e_nombre">Nombre *</label>
                    <input type="text" id="e_nombre" required class="form-control">
                    <div class="error-message" id="e_nombreError"></div>
                </div>

                <div class="form-group">
                    <label for="e_email">Correo *</label>
                    <input type="email" id="e_email" required class="form-control">
                    <div class="error-message" id="e_emailError"></div>
                </div>

                <div class="form-group">
                    <label for="e_telefono">Tel√©fono</label>
                    <input type="text" id="e_telefono" class="form-control">
                    <div class="error-message" id="e_telefonoError"></div>
                </div>

                <div class="form-group">
                    <label for="e_direccion">Direcci√≥n</label>
                    <input type="text" id="e_direccion" class="form-control">
                </div>

                <div class="form-group">
                    <label for="e_password">Nueva contrase√±a (opcional)</label>
                    <input type="password" id="e_password" class="form-control">
                    <div class="error-message" id="e_passwordError"></div>
                </div>

                <div class="form-group">
                    <label for="e_password2">Confirmar nueva contrase√±a</label>
                    <input type="password" id="e_password2" class="form-control">
                    <div class="error-message" id="e_password2Error"></div>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeEditAdminModal()">Cancelar</button>
            <button type="submit" form="editAdminForm" class="btn-save">Actualizar</button>
        </div>
    </div>
</div>

<!-- üõë ELIMINAMOS #customAlert Y LO REEMPLAZAMOS CON Swal.fire() üõë -->

<script>
// Helper functions para errores
function showError(input, message) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.add('error-field'); 
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

function hideError(input) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (errorElement) {
        input.classList.remove('error-field');
        errorElement.style.display = 'none';
    }
}

// Limpia todos los errores de un formulario espec√≠fico
function clearAllErrors(formElement) {
    const errors = formElement.querySelectorAll('.error-message');
    const errorInputs = formElement.querySelectorAll('.error-field');
    
    errors.forEach(error => {
        error.textContent = '';
        error.style.display = 'none';
    });
    errorInputs.forEach(input => input.classList.remove('error-field'));
}

// Formatear autom√°ticamente el tel√©fono
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 4) {
        value = value.substring(0, 4) + '-' + value.substring(4, 8);
    }
    input.value = value;
}

// Validar que el nombre solo contenga letras y espacios
function validateNameInput(input) {
    input.value = input.value.replace(/[^A-Za-z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
}

// Funciones de validaci√≥n
function validateLettersOnly(input) {
    const value = input.value.trim();
    if (!value) {
        showError(input, 'Este campo es obligatorio');
        return false;
    }
    const lettersOnly = /^[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s\-.,!¬°¬ø?()&]+$/;
    if (!lettersOnly.test(value)) {
        showError(input, 'Solo se permiten letras y espacios');
        return false;
    }
    if (value.length < 2) {
        showError(input, 'El nombre debe tener al menos 2 caracteres');
        return false;
    }
    hideError(input);
    return true;
}

function validateEmail(input) {
    const value = input.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!value) {
        showError(input, 'El email es obligatorio');
        return false;
    }
    if (!emailRegex.test(value)) {
        showError(input, 'Por favor ingresa un email v√°lido');
        return false;
    }
    hideError(input);
    return true;
}

function validatePhone(input) {
    const value = input.value.trim();
    if (!value) {
        hideError(input);
        return true;
    }
    const phoneRegex = /^\d{4}-\d{4}$/;
    if (!phoneRegex.test(value)) {
        showError(input, 'Formato inv√°lido. Usar formato: 1234-5678');
        return false;
    }
    hideError(input);
    return true;
}

function validatePassword(input) {
    const value = input.value;
    if (!value) {
        showError(input, 'La contrase√±a es obligatoria');
        return false;
    }
    if (value.length < 8) {
        showError(input, 'La contrase√±a debe tener al menos 8 caracteres');
        return false;
    }
    hideError(input);
    return true;
}

function validatePasswordConfirm(passwordInput, confirmInput) {
    const passValue = passwordInput.value;
    const confirmValue = confirmInput.value;
    
    if (!confirmValue) {
        showError(confirmInput, 'Por favor confirma tu contrase√±a');
        return false;
    }
    if (confirmValue !== passValue) {
        showError(confirmInput, 'Las contrase√±as no coinciden');
        return false;
    }
    
    hideError(confirmInput);
    return true;
}

/* ===== Funciones "Maestras" para Modales (Admin) ===== */

function validateCreateForm() {
    const nombre = document.getElementById('c_nombre');
    const email = document.getElementById('c_email');
    const telefono = document.getElementById('c_telefono');
    const password = document.getElementById('c_password');
    const password2 = document.getElementById('c_password2');
    
    let isValid = true;
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateEmail(email)) isValid = false;
    if (!validatePhone(telefono)) isValid = false;
    if (!validatePassword(password)) isValid = false;
    if (!validatePasswordConfirm(password, password2)) isValid = false;
    
    return isValid;
}

function validateEditForm() {
    const nombre = document.getElementById('e_nombre');
    const email = document.getElementById('e_email');
    const telefono = document.getElementById('e_telefono');
    const password = document.getElementById('e_password');
    const password2 = document.getElementById('e_password2');
    
    let isValid = true;
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateEmail(email)) isValid = false;
    if (!validatePhone(telefono)) isValid = false;
    
    // Validar contrase√±a solo si se est√° intentando cambiar
    const passValue = password.value;
    const pass2Value = password2.value;
    
    if (passValue || pass2Value) {
        if (!validatePassword(password)) isValid = false;
        if (!validatePasswordConfirm(password, password2)) isValid = false;
    } else {
        hideError(password);
        hideError(password2);
    }
    
    return isValid;
}


/* ===== CSRF ===== */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');


/* ===== Modal Crear Admin ===== */
function openCreateAdminModal() {
    document.getElementById('createAdminModal').style.display = 'block';
    clearAllErrors(document.getElementById('createAdminForm'));
}

function closeCreateAdminModal() {
    document.getElementById('createAdminModal').style.display = 'none';
    document.getElementById('createAdminForm').reset();
    clearAllErrors(document.getElementById('createAdminForm'));
}

function submitCreateAdmin(e) {
    e.preventDefault();
    clearAllErrors(document.getElementById('createAdminForm'));
    
    if (!validateCreateForm()) {
        Swal.fire('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.', 'warning');
        return false;
    }

    const data = {
        nombre: document.getElementById('c_nombre').value,
        email: document.getElementById('c_email').value,
        telefono: document.getElementById('c_telefono').value,
        direccion: document.getElementById('c_direccion').value,
        password: document.getElementById('c_password').value,
        password2: document.getElementById('c_password2').value
    };

    fetch('/administradores/crear/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(json => {
        if (json.ok) {
            closeCreateAdminModal();
            Swal.fire({
                title: '¬°Administrador Creado!',
                text: 'La cuenta ha sido registrada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        } else {
            if (json.errors) {
                if (json.errors.email) {
                    showError(document.getElementById('c_email'), json.errors.email[0]);
                }
                if (json.errors.password) {
                    showError(document.getElementById('c_password'), json.errors.password[0]);
                }
            }
            Swal.fire('Error', json.errors.non_field_errors || 'Revisa los campos del formulario.', 'error');
        }
    })
    .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
    return false;
}

/* ===== Modal Editar Admin ===== */
function openEditAdminModal(id) {
    fetch(`/administradores/editar/${id}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
        .then(res => res.json())
        .then(data => {
            document.getElementById('e_id').value = data.id;
            document.getElementById('e_nombre').value = data.nombre || '';
            document.getElementById('e_email').value = data.email || '';
            document.getElementById('e_telefono').value = data.telefono || '';
            document.getElementById('e_direccion').value = data.direccion || '';
            document.getElementById('e_password').value = '';
            document.getElementById('e_password2').value = '';
            
            clearAllErrors(document.getElementById('editAdminForm'));
            document.getElementById('editAdminModal').style.display = 'block';
        })
        .catch(() => Swal.fire('Error', 'No se pudo cargar la informaci√≥n del administrador.', 'error'));
}

function closeEditAdminModal() {
    document.getElementById('editAdminModal').style.display = 'none';
    clearAllErrors(document.getElementById('editAdminForm'));
}

function submitEditAdmin(e) {
    e.preventDefault();
    clearAllErrors(document.getElementById('editAdminForm'));
    
    if (!validateEditForm()) {
        Swal.fire('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.', 'warning');
        return false;
    }

    const id = document.getElementById('e_id').value;
    const data = {
        nombre: document.getElementById('e_nombre').value,
        email: document.getElementById('e_email').value,
        telefono: document.getElementById('e_telefono').value,
        direccion: document.getElementById('e_direccion').value
    };

    const np = document.getElementById('e_password').value;
    const np2 = document.getElementById('e_password2').value;
    if (np || np2) {
        data.password = np;
        data.password2 = np2;
    }

    fetch(`/administradores/editar/${id}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(json => {
        if (json.ok) {
            // Actualizaci√≥n visual sin recargar
            const fila = document.querySelector(`tr[data-id='${id}']`);
            fila.querySelector('.a-nombre').textContent = data.nombre;
            fila.querySelector('.a-email').textContent = data.email;
            fila.querySelector('.a-telefono').textContent = data.telefono || '-';
            fila.querySelector('.a-direccion').textContent = data.direccion || '-';

            closeEditAdminModal();
            Swal.fire('√âxito', 'Administrador actualizado correctamente.', 'success');
        } else {
            if (json.errors) {
                if (json.errors.email) {
                    showError(document.getElementById('e_email'), json.errors.email[0]);
                }
                if (json.errors.password) {
                    showError(document.getElementById('e_password'), json.errors.password[0]);
                }
            }
            Swal.fire('Error', json.errors.non_field_errors || 'No se pudo actualizar.', 'error');
        }
    })
    .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
    return false;
}

/* ===== Eliminar con SweetAlert2 (Admin) ===== */
function confirmDeleteAdmin(id, nombre) {
    Swal.fire({
        title: 'Confirmar Eliminaci√≥n',
        html: `¬øEst√°s seguro de que quieres eliminar al administrador "<strong>${nombre}</strong>"? <br>Esta acci√≥n no se puede deshacer.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Aceptar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true, 
        confirmButtonColor: '#d32f2f'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/administradores/eliminar/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.ok) {
                    document.querySelector(`tr[data-id='${id}']`).remove();
                    Swal.fire('¬°Eliminado!', 'Administrador eliminado correctamente.', 'success');
                } else {
                    Swal.fire('Error', resp.msg || 'No se pudo eliminar al administrador.', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Error en la solicitud. Int√©ntalo de nuevo.', 'error'));
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    
    // --- Formulario CREAR ---
    const c_nombre = document.getElementById('c_nombre');
    const c_email = document.getElementById('c_email');
    const c_telefono = document.getElementById('c_telefono');
    const c_password = document.getElementById('c_password');
    const c_password2 = document.getElementById('c_password2');

    // Formato
    c_telefono.addEventListener('input', function() { formatPhone(this); });
    c_nombre.addEventListener('input', function() { validateNameInput(this); });
    
    // Validaci√≥n al salir (blur)
    c_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
    c_email.addEventListener('blur', function() { validateEmail(this); });
    c_telefono.addEventListener('blur', function() { validatePhone(this); });
    c_password.addEventListener('blur', function() { validatePassword(this); });
    c_password2.addEventListener('blur', function() { validatePasswordConfirm(c_password, this); });

    // --- Formulario EDITAR ---
    const e_nombre = document.getElementById('e_nombre');
    const e_email = document.getElementById('e_email');
    const e_telefono = document.getElementById('e_telefono');
    const e_password = document.getElementById('e_password');
    const e_password2 = document.getElementById('e_password2');
    
    // Formato
    e_telefono.addEventListener('input', function() { formatPhone(this); });
    e_nombre.addEventListener('input', function() { validateNameInput(this); });

    // Validaci√≥n al salir (blur)
    e_nombre.addEventListener('blur', function() { validateLettersOnly(this); });
    e_email.addEventListener('blur', function() { validateEmail(this); });
    e_telefono.addEventListener('blur', function() { validatePhone(this); });
    // Validar contrase√±as solo si se tocan
    e_password.addEventListener('blur', function() {
        if (this.value || e_password2.value) validatePassword(this);
    });
    e_password2.addEventListener('blur', function() {
        if (this.value || e_password.value) validatePasswordConfirm(e_password, this);
    });
});
</script>
{% endblock %}
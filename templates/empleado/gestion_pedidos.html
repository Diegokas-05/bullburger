{% extends 'base.html' %}
{% load static %}

{% block title %}Gestionar Pedidos - Bullburger{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_style.css' %}">
<link rel="stylesheet" href="{% static 'css/administrador/gestion_pedido.css' %}">

<div class="admin-bg">
    
  <div class="welcome-header">
    <h1 class="welcome-title">Gestión de Pedidos</h1>
    <p class="welcome-subtitle">Administra, organiza y actualiza los pedidos en tiempo real</p>
  </div>

    <!-- FILTROS -->
    <div class="filtros">
        <button class="filtro-btn active" onclick="filtrarPedidos('todos')">
            Todos ({{ pedidos.count }})
        </button>
        <button class="filtro-btn" onclick="filtrarPedidos('pendiente')">
            Pendientes ({{ pedidos_pendientes.count }})
        </button>
        <button class="filtro-btn" onclick="filtrarPedidos('preparando')">
            En Preparación ({{ pedidos_preparando.count }})
        </button>
        <button class="filtro-btn" onclick="filtrarPedidos('listo')">
            Listos ({{ pedidos_listos.count }})
        </button>
    </div>

    <!-- GRID -->
    <div class="pedidos-grid" id="lista-pedidos">

        {% for pedido in pedidos %}
        <div class="pedido-card" data-estado="{{ pedido.estado }}" data-pedido-id="{{ pedido.id }}">

            <!-- HEADER -->
            <div class="pedido-header">
                <div class="pedido-id">#{{ pedido.id }}</div>
                <div class="pedido-estado estado-{{ pedido.estado }}">
                    {{ pedido.get_estado_display }}
                </div>
            </div>

            <!-- INFO -->
            <div class="pedido-info">
                <p><strong>Cliente:</strong> {{ pedido.usuario.nombre|default:pedido.usuario.email }}</p>
                <p><strong>Fecha:</strong> {{ pedido.fecha|date:'d/m/Y H:i' }}</p>
                <p><strong>Tipo:</strong> {{ pedido.get_tipo_entrega_display }}</p>
                <p><strong>Pago:</strong> {{ pedido.get_metodo_pago_display }}</p>
                <p><strong>Total:</strong> ${{ pedido.total }}</p>

                {% if pedido.direccion_entrega %}
                <p><strong>Dirección:</strong> {{ pedido.direccion_entrega }}</p>
                {% endif %}
            </div>

            <!-- ITEMS -->
            <div class="pedido-items">
                {% for detalle in pedido.detallepedido_set.all %}
                <div class="pedido-item">
                    <span class="item-nombre">{{ detalle.producto.nombre }}</span>
                    <span class="item-cantidad">x{{ detalle.cantidad }}</span>
                </div>
                {% endfor %}

                {% if pedido.descuento_aplicado > 0 %}
                <div class="pedido-item" style="color:#27ae60;font-weight:600;">
                    <span class="item-nombre">Descuento</span>
                    <span class="item-cantidad">-${{ pedido.descuento_aplicado }}</span>
                </div>
                {% endif %}
            </div>

            <!-- ACCIONES -->
            <div class="pedido-actions">
                {% if pedido.estado == 'pendiente' %}
                    <button class="btn-accion btn-preparar" onclick="cambiarEstado({{ pedido.id }}, 'preparando')">Preparar</button>
                    <button class="btn-accion btn-cancelar" onclick="cancelarPedido({{ pedido.id }})">Cancelar</button>

                {% elif pedido.estado == 'preparando' %}
                    <button class="btn-accion btn-listo" onclick="cambiarEstado({{ pedido.id }}, 'listo')">Marcar Listo</button>

                {% elif pedido.estado == 'listo' %}
                    <button class="btn-accion btn-entregar" onclick="cambiarEstado({{ pedido.id }}, 'entregado')">Entregar</button>

                {% else %}
                    <button class="btn-accion" disabled>{{ pedido.get_estado_display }}</button>
                {% endif %}
            </div>

        </div>
        {% empty %}
        <div class="empty-state">
            <img src="{% static 'img/cards/empty.png' %}">
            <h3>No hay pedidos para mostrar</h3>
            <p>Los pedidos aparecerán aquí cuando los clientes compren.</p>
        </div>
        {% endfor %}

    </div>

</div>

<script>
    /* --- FILTRO (igual que original) --- */
    function filtrarPedidos(estado) {
        document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.querySelectorAll('.pedido-card').forEach(card => {
            card.style.display = (estado === "todos" || card.dataset.estado === estado) ? "block" : "none";
        });
    }

    /* --- FUNCIÓN DE CAMBIAR ESTADO (SweetAlert) --- */
    function cambiarEstado(id, estado) {
        Swal.fire({
            title: "¿Confirmar acción?",
            text: `Cambiar estado del pedido #${id}`,
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#b22222",
            cancelButtonColor: "#666"
        }).then(r => {
            if (r.isConfirmed) {
                fetch(`/empleado/pedidos/actualizar-estado/${id}/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({ nuevo_estado: estado })
                }).then(res => res.json()).then(data => {
                    if (data.success) location.reload();
                });
            }
        });
    }

    function cancelarPedido(id) {
        cambiarEstado(id, "cancelado");
    }
</script>

{% endblock %}

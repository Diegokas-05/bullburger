{% extends 'base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Inventario - BullBurger{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/Administrador/inventario.css' %}">

<style>
/* =========================================
   1. ESTILOS DE LA ALERTA PERSONALIZADA 
   ========================================= */
#customAlert.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  /* Centrado perfecto del modal */
  align-items: center;
  justify-content: center;
}

#customAlert .modal-content {
  background-color: white;
  margin: 0;
  padding: 0;
  border-radius: 15px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: modalSlideIn 0.3s ease;
}

.custom-alert-header {
  padding: 30px 20px;
  background: transparent;
  display: flex;
  justify-content: center;
  align-items: center;
}

.custom-alert-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid #3498db;
  color: #3498db;
  font-size: 2.5rem;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 15px;
}

/* =========================================
   2. CORRECCI√ìN DE BOTONES (TEXTO CENTRADO)
   ========================================= */
.btn-cancel, .btn-save {
    /* Estas 3 l√≠neas centran el texto perfectamente */
    display: inline-flex !important;
    justify-content: center !important;
    align-items: center !important;
    
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s ease;
    min-height: 45px; /* Altura m√≠nima para que se vean iguales */
    line-height: 1;
}

.btn-cancel {
    background: #95a5a6;
    color: white;
}
.btn-cancel:hover { background: #7f8c8d; }

.btn-save {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
}

.alert-ok-btn {
  background: #e74c3c !important; /* Rojo para eliminar */
  box-shadow: none;
}
</style>

<div class="admin-bg">
  <section class="contenedor_dashboard">
    <div class="inventario-dashboard">
      <div class="dashboard-header">
        <h1 class="welcome-title">Gesti√≥n de Inventario - BullBurger</h1>
        <p class="welcome-subtitle">Controla tus ingredientes y materias primas</p>
      </div>

      <div class="action-buttons">
        <button class="add-ingrediente-btn" onclick="openAddIngredienteModal()">
          <span>+</span> Agregar Ingrediente
        </button>
      </div>

      {% if ingredientes_bajos %}
      <div class="alert-section">
        <div class="alert-header">
          <h3>‚ö†Ô∏è Alertas de Stock Bajo</h3>
          <span class="alert-count">{{ ingredientes_bajos|length }}</span>
        </div>
        <div class="alert-grid">
          {% for ingrediente in ingredientes_bajos %}
          <div class="alert-item {% if ingrediente.estado_stock == 'agotado' %}alert-danger{% else %}alert-warning{% endif %}">
            <div class="alert-info">
              <span class="alert-nombre">{{ ingrediente.nombre }}</span>
              <span class="alert-stock">{{ ingrediente.stock_actual }} {{ ingrediente.unidad_medida }}</span>
              <span class="alert-minimo">M√≠nimo: {{ ingrediente.stock_minimo }}</span>
            </div>
            <button class="btn-ajustar-small" onclick="openAjustarModal({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')">
              Ajustar Stock
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="table-section">
        <div class="section-header">
          <h3>üì¶ Todos los Ingredientes</h3>
          <div class="section-actions">
            <span class="total-count">{{ ingredientes|length }} ingredientes</span>
          </div>
        </div>
        
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Ingrediente</th>
                <th>Stock Actual</th>
                <th>Stock M√≠nimo</th>
                <th>Unidad</th>
                <th>Costo Unitario</th>
                <th>Valor Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for ingrediente in ingredientes %}
              <tr class="data-row {% if ingrediente.estado_stock == 'bajo' %}row-warning{% elif ingrediente.estado_stock == 'agotado' %}row-danger{% endif %}">
                <td class="ingrediente-info">
                  <div class="ingrediente-nombre">
                    <strong>{{ ingrediente.nombre }}</strong>
                    {% if ingrediente.proveedor %}
                    <small>Prov: {{ ingrediente.proveedor }}</small>
                    {% endif %}
                  </div>
                </td>
                <td class="stock-actual">{{ ingrediente.stock_actual }}</td>
                <td class="stock-minimo">{{ ingrediente.stock_minimo }}</td>
                <td class="unidad">{{ ingrediente.unidad_medida }}</td>
                <td class="costo">${{ ingrediente.costo_unitario|floatformat:4 }}</td>
                <td class="valor-total">${{ ingrediente.valor_total|floatformat:2 }}</td>
                <td class="estado">
                  <span class="status-badge status-{{ ingrediente.estado_stock }}">
                    {% if ingrediente.estado_stock == 'normal' %}‚úÖ Normal
                    {% elif ingrediente.estado_stock == 'bajo' %}‚ö†Ô∏è Bajo
                    {% else %}üî¥ Agotado{% endif %}
                  </span>
                </td>
                <td class="acciones">
                  <div class="action-buttons-small">
                    <button class="btn-action btn-edit" onclick="openEditIngredienteModal({{ ingrediente.id }})" title="Editar"><span>‚úèÔ∏è</span></button>
                    <button class="btn-action btn-ajustar" onclick="openAjustarModal({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')" title="Ajustar Stock"><span>üìä</span></button>
                    <button class="btn-action btn-delete" onclick="confirmDeleteIngrediente({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')" title="Eliminar"><span>üóëÔ∏è</span></button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="no-data">
                  <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>No hay ingredientes registrados</h3>
                    <p>Comienza agregando tu primer ingrediente al inventario</p>
                    <button class="btn-primary" onclick="openAddIngredienteModal()">Agregar Primer Ingrediente</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="addIngredienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Agregar Nuevo Ingrediente</h2>
            <span class="close" onclick="closeAddIngredienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addIngredienteForm" method="post" action="{% url 'crear_ingrediente' %}" onsubmit="return validateAddIngredienteForm(event)">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="nombre">Nombre del Ingrediente *</label>
                    <input type="text" id="nombre" name="nombre" required class="form-control"
                    pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                    title="Solo se permiten letras y espacios"
                    oninput="validateLettersOnly(this)"
                    placeholder="Ej: Queso Americano">
                    <div class="error-message" id="nombreError"></div>
                </div>

                <div class="form-group">
                    <label for="unidad_medida">Unidad de Medida *</label>
                    <select id="unidad_medida" name="unidad_medida" required class="form-control">
                        <option value="">Selecciona unidad</option>
                        <option value="kg">Kilogramos (kg)</option>
                        <option value="g">Gramos (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                        <option value="unidad">Unidades</option>
                        <option value="lb">Libras (lb)</option>
                    </select>
                    <div class="error-message" id="unidad_medidaError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio_paquete">Precio del Paquete ($) *</label>
                        <input type="number" id="precio_paquete" name="precio_paquete" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="3.99">
                        <div class="error-message" id="precio_paqueteError"></div>
                    </div>
                                    
                    <div class="form-group">
                        <label for="tama√±o_paquete">Tama√±o del Paquete *</label>
                        <input type="number" id="tama√±o_paquete" name="tama√±o_paquete" 
                            step="0.01" min="0.01" required class="form-control"
                            oninput="validatePositiveNumber(this)"
                            placeholder="400">
                        <small class="help-text">En la unidad seleccionada</small>
                        <div class="error-message" id="tama√±o_paqueteError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="stock_actual">Stock Actual *</label>
                        <input type="number" id="stock_actual" name="stock_actual" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="0">
                        <div class="error-message" id="stock_actualError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock_minimo">Stock M√≠nimo *</label>
                        <input type="number" id="stock_minimo" name="stock_minimo" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="10">
                        <div class="error-message" id="stock_minimoError"></div>
                    </div>
                </div>

                <div class="form-group calculation-display">
                    <label>C√°lculo Autom√°tico:</label>
                    <div id="costo-calculation" class="calculation-result">
                        Costo por unidad: <span id="costo-unitario">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <input type="text" id="proveedor" name="proveedor" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Nombre del proveedor">
                        <div class="error-message" id="proveedorError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ubicacion">Ubicaci√≥n</label>
                        <input type="text" id="ubicacion" name="ubicacion" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Ej: Almac√©n A, Refrigerador">
                        <div class="error-message" id="ubicacionError"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddIngredienteModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Ingrediente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="editIngredienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Ingrediente</h2>
            <span class="close" onclick="closeEditIngredienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editIngredienteForm" method="post" action="" onsubmit="return validateEditIngredienteForm(event)">
                {% csrf_token %}
                <input type="hidden" id="edit_ingrediente_id" name="ingrediente_id">
                
                <div class="form-group">
                    <label for="edit_nombre">Nombre del Ingrediente *</label>
                    <input type="text" id="edit_nombre" name="nombre" required class="form-control" 
                        pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                        title="Solo se permiten letras y espacios"
                        oninput="validateLettersOnly(this)"
                        placeholder="Nombre del ingrediente">
                    <div class="error-message" id="edit_nombreError"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit_unidad_medida">Unidad de Medida *</label>
                    <select id="edit_unidad_medida" name="unidad_medida" required class="form-control">
                        <option value="">Selecciona unidad</option>
                        <option value="kg">Kilogramos (kg)</option>
                        <option value="g">Gramos (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                        <option value="unidad">Unidades</option>
                        <option value="lb">Libras (lb)</option>
                    </select>
                    <div class="error-message" id="edit_unidad_medidaError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_precio_paquete">Precio del Paquete ($) *</label>
                        <input type="number" id="edit_precio_paquete" name="precio_paquete" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="0.00">
                        <div class="error-message" id="edit_precio_paqueteError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_tama√±o_paquete">Tama√±o del Paquete *</label>
                        <input type="number" id="edit_tama√±o_paquete" name="tama√±o_paquete" 
                            step="0.01" min="0.01" required class="form-control"
                            oninput="validatePositiveNumber(this)"
                            placeholder="1.00">
                        <div class="error-message" id="edit_tama√±o_paqueteError"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_stock_actual">Stock Actual *</label>
                        <input type="number" id="edit_stock_actual" name="stock_actual" 
                            step="0.01" min="0" required class="form-control" 
                            oninput="validateNumber(this)"
                            placeholder="0">
                        <div class="error-message" id="edit_stock_actualError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_stock_minimo">Stock M√≠nimo *</label>
                        <input type="number" id="edit_stock_minimo" name="stock_minimo" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="10">
                        <div class="error-message" id="edit_stock_minimoError"></div>
                    </div>
                </div>

                <div class="form-group calculation-display">
                    <label>C√°lculo Autom√°tico:</label>
                    <div class="calculation-result">
                        Costo por unidad: <span id="edit-costo-unitario">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_proveedor">Proveedor</label>
                        <input type="text" id="edit_proveedor" name="proveedor" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Nombre del proveedor">
                        <div class="error-message" id="edit_proveedorError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_ubicacion">Ubicaci√≥n</label>
                        <input type="text" id="edit_ubicacion" name="ubicacion" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Ej: Almac√©n A, Refrigerador">
                        <div class="error-message" id="edit_ubicacionError"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditIngredienteModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Actualizar Ingrediente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="ajustarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="ajustarModalTitle">Ajustar Inventario</h2>
            <span class="close" onclick="closeAjustarModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="ajustarForm" method="post" action="" onsubmit="return validateAjusteForm(event)">
                {% csrf_token %}
                <input type="hidden" id="ajustar_ingrediente_id" name="ingrediente_id">
                
                <div class="form-group">
                    <label for="ajustar_nombre">Ingrediente</label>
                    <input type="text" id="ajustar_nombre" readonly class="form-control readonly-input">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="stock_actual_ajuste">Stock Actual</label>
                        <input type="text" id="stock_actual_ajuste" readonly class="form-control readonly-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="cantidad_nueva">Nueva Cantidad *</label>
                        <input type="number" id="cantidad_nueva" name="cantidad_nueva" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)">
                        <div class="error-message" id="cantidad_nuevaError"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="motivo_ajuste">Motivo del Ajuste *</label>
                    <textarea id="motivo_ajuste" name="motivo" rows="3" required class="form-control" 
                        placeholder="Ej: Conteo f√≠sico, Ajuste por p√©rdida, Correcci√≥n..."></textarea>
                    <div class="error-message" id="motivo_ajusteError"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAjustarModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Aplicar Ajuste</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteIngredienteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<div id="customAlert" class="modal">
    <div class="modal-content" style="max-width: 450px; text-align: center; padding: 0;">
        <div class="custom-alert-header">
            <div class="custom-alert-icon">?</div> 
        </div>
        <div class="modal-body" style="padding: 30px 20px;">
            <h2 id="alertTitle" style="color: #333; font-size: 1.5rem; margin-bottom: 10px;">¬øConfirmar acci√≥n?</h2>
            <p id="alertMessage" style="color: #666; font-size: 1rem; margin-bottom: 30px;">
            </p>
            
            <div class="form-actions" style="display: flex; justify-content: center; gap: 30px; width: 100%;">
                
                <button type="button" class="btn-cancel" id="alertCancelBtn" onclick="closeCustomAlert()" 
                        style="background: #95a5a6; color: white; width: 120px; height: 45px; display: flex; justify-content: center; align-items: center;">
                    Cancelar
                </button>
                
                <button type="button" class="btn-save alert-ok-btn" id="alertConfirmBtn" 
                        style="background: #e74c3c; width: 120px; height: 45px; display: flex; justify-content: center; align-items: center; box-shadow: none;">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// --- ALERTA PERSONALIZADA ---
function showCustomAlert(title, message, confirmCallback = null) {
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertMessage').textContent = message;
    const modal = document.getElementById('customAlert');
    
    // IMPORTANTE: Display flex para centrar en la pantalla
    modal.style.display = 'flex'; 
    
    const confirmBtn = document.getElementById('alertConfirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    if (confirmCallback) {
        newConfirmBtn.onclick = function() {
            confirmCallback();
            closeCustomAlert();
        };
    } else {
        newConfirmBtn.onclick = closeCustomAlert;
    }
}

function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
}

// --- Funciones de Modales ---
function openAddIngredienteModal() {
    document.getElementById('addIngredienteModal').style.display = 'flex';
    document.getElementById('addIngredienteForm').reset();
    clearAllErrors();
}

function closeAddIngredienteModal() {
    document.getElementById('addIngredienteModal').style.display = 'none';
}

function openEditIngredienteModal(ingredienteId) {
    fetch(`/inventario/api/ingrediente/${ingredienteId}/`)
    .then(response => response.json())
    .then(data => {
        document.getElementById('edit_ingrediente_id').value = data.id;
        document.getElementById('edit_nombre').value = data.nombre;
        document.getElementById('edit_unidad_medida').value = data.unidad_medida;
        document.getElementById('edit_precio_paquete').value = data.precio_paquete;
        document.getElementById('edit_tama√±o_paquete').value = data.tama√±o_paquete;
        document.getElementById('edit_stock_actual').value = data.stock_actual;
        document.getElementById('edit_stock_minimo').value = data.stock_minimo;
        document.getElementById('edit_proveedor').value = data.proveedor;
        document.getElementById('edit_ubicacion').value = data.ubicacion;
        
        calculateEditUnitCost();
        document.getElementById('editIngredienteForm').action = `/inventario/ingrediente/editar/${ingredienteId}/`;
        document.getElementById('editIngredienteModal').style.display = 'flex';
        clearAllErrors();
    })
    .catch(error => showCustomAlert('Error', 'No se pudieron cargar los datos'));
}

function closeEditIngredienteModal() {
    document.getElementById('editIngredienteModal').style.display = 'none';
}

function openAjustarModal(ingredienteId, ingredienteNombre) {
    fetch(`/inventario/api/ingrediente/${ingredienteId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('ajustarModal').style.display = 'flex';
            document.getElementById('ajustarModalTitle').textContent = `Ajustar ${data.nombre}`;
            document.getElementById('ajustar_nombre').value = data.nombre;
            document.getElementById('ajustar_ingrediente_id').value = data.id;
            document.getElementById('stock_actual_ajuste').value = `${data.stock_actual} ${data.unidad_medida}`;
            document.getElementById('cantidad_nueva').value = data.stock_actual;
            document.getElementById('ajustarForm').action = `/inventario/ajustar/${ingredienteId}/`;
            clearAllErrors();
        })
        .catch(error => showCustomAlert('Error', 'No se pudieron cargar los datos'));
}

function closeAjustarModal() {
    document.getElementById('ajustarModal').style.display = 'none';
}

// --- Validaciones y C√°lculos ---
function validateLettersOnly(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById(input.id + 'Error');
    const lettersOnly = /^[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+$/;
    if (input.required && !value) { showError(input, errorElement, 'Requerido'); return false; }
    if (value && !lettersOnly.test(value)) { showError(input, errorElement, 'Solo letras'); return false; }
    hideError(input, errorElement);
    return true;
}

function validateNumber(input) {
    const value = parseFloat(input.value);
    const errorElement = document.getElementById(input.id + 'Error');
    if (!input.value) { showError(input, errorElement, 'Requerido'); return false; }
    if (isNaN(value) || value < 0) { showError(input, errorElement, 'Inv√°lido'); return false; }
    hideError(input, errorElement);
    if (input.id.includes('precio') || input.id.includes('tama√±o')) {
        input.id.includes('edit') ? calculateEditUnitCost() : calculateUnitCost();
    }
    return true;
}

function validatePositiveNumber(input) {
    const value = parseFloat(input.value);
    const errorElement = document.getElementById(input.id + 'Error');
    if (!input.value) { showError(input, errorElement, 'Requerido'); return false; }
    if (isNaN(value) || value <= 0) { showError(input, errorElement, 'Mayor a 0'); return false; }
    hideError(input, errorElement);
    if (input.id.includes('precio') || input.id.includes('tama√±o')) {
        input.id.includes('edit') ? calculateEditUnitCost() : calculateUnitCost();
    }
    return true;
}

function calculateUnitCost() {
    const precio = parseFloat(document.getElementById('precio_paquete')?.value) || 0;
    const tama√±o = parseFloat(document.getElementById('tama√±o_paquete')?.value) || 1;
    document.getElementById('costo-unitario').textContent = (precio > 0 && tama√±o > 0) ? `$${(precio / tama√±o).toFixed(6)}` : '$0.00';
}

function calculateEditUnitCost() {
    const precio = parseFloat(document.getElementById('edit_precio_paquete')?.value) || 0;
    const tama√±o = parseFloat(document.getElementById('edit_tama√±o_paquete')?.value) || 1;
    document.getElementById('edit-costo-unitario').textContent = (precio > 0 && tama√±o > 0) ? `$${(precio / tama√±o).toFixed(6)}` : '$0.00';
}

function showError(input, errorElement, message) {
    input.style.borderColor = '#e74c3c';
    if (errorElement) { errorElement.textContent = message; errorElement.style.display = 'block'; }
}

function hideError(input, errorElement) {
    input.style.borderColor = '#e0e0e0';
    if (errorElement) { errorElement.style.display = 'none'; }
}

function clearAllErrors() {
    document.querySelectorAll('.error-message').forEach(e => e.style.display = 'none');
    document.querySelectorAll('.form-control').forEach(i => i.style.borderColor = '#e0e0e0');
}

function validateAddIngredienteForm(event) {
    // ... (tus validaciones completas) ...
    // Si falla algo:
    // event.preventDefault(); showCustomAlert('Error', 'Corrige los errores'); return false;
    return true; // Simplificado para brevedad, usa tu l√≥gica completa
}

function validateEditIngredienteForm(event) { return true; }
function validateAjusteForm(event) { return true; }

function confirmDeleteIngrediente(id, nombre) {
    showCustomAlert(
        'Confirmar Eliminaci√≥n',
        `¬øEst√°s seguro de eliminar "${nombre}"?`,
        function() {
            const form = document.getElementById('deleteIngredienteForm');
            form.action = `/inventario/ingrediente/eliminar/${id}/`;
            form.submit();
        }
    );
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAddIngredienteModal(); closeEditIngredienteModal(); closeAjustarModal(); closeCustomAlert();
    }
});
</script>
{% endblock %}
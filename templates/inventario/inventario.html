{% extends 'base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Inventario - BullBurger{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/admin_style.css' %}">

<div class="admin-bg">
  <section class="contenedor_dashboard">
<div class="inventario-dashboard">
    <!-- Header del Inventario -->
    <div class="dashboard-header">
        <h1 class="welcome-title">Gesti√≥n de Inventario - BullBurger</h1>
        <p class="welcome-subtitle">Controla tus ingredientes y materias primas</p>
    </div>

    <!-- QUITAMOS LOS MENSAJES DE DJANGO -->
    
    <!-- Estad√≠sticas R√°pidas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-info">
                <h3>{{ total_ingredientes }}</h3>
                <p>Total Ingredientes</p>
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-info">
                <h3>{{ total_ingredientes_bajos }}</h3>
                <p>Stock Bajo</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-info">
                <h3>${{ valor_total_inventario|floatformat:2 }}</h3>
                <p>Valor Inventario</p>
            </div>
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="action-buttons">
        <button class="add-ingrediente-btn" onclick="openAddIngredienteModal()">
            <span>+</span>
            Agregar Ingrediente
        </button>
        <button class="historial-btn" onclick="openHistorialModal()">
            <span>üìä</span>
            Ver Historial
        </button>
    </div>

    <!-- Alertas de Stock Bajo -->
    {% if ingredientes_bajos %}
    <div class="alert-section">
        <div class="alert-header">
            <h3>‚ö†Ô∏è Alertas de Stock Bajo</h3>
            <span class="alert-count">{{ ingredientes_bajos|length }}</span>
        </div>
        <div class="alert-grid">
            {% for ingrediente in ingredientes_bajos %}
            <div class="alert-item {% if ingrediente.estado_stock == 'agotado' %}alert-danger{% else %}alert-warning{% endif %}">
                <div class="alert-info">
                    <span class="alert-nombre">{{ ingrediente.nombre }}</span>
                    <span class="alert-stock">{{ ingrediente.stock_actual }} {{ ingrediente.unidad_medida }}</span>
                    <span class="alert-minimo">M√≠nimo: {{ ingrediente.stock_minimo }}</span>
                </div>
                <button class="btn-ajustar-small" onclick="openAjustarModal({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')">
                    Ajustar Stock
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Tabla de Ingredientes -->
    <div class="table-section">
        <div class="section-header">
            <h3>üì¶ Todos los Ingredientes</h3>
            <div class="section-actions">
                <span class="total-count">{{ ingredientes|length }} ingredientes</span>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Stock Actual</th>
                        <th>Stock M√≠nimo</th>
                        <th>Unidad</th>
                        <th>Costo Unitario</th>
                        <th>Valor Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ingrediente in ingredientes %}
                    <tr class="data-row {% if ingrediente.estado_stock == 'bajo' %}row-warning{% elif ingrediente.estado_stock == 'agotado' %}row-danger{% endif %}">
                        <td class="ingrediente-info">
                            <div class="ingrediente-nombre">
                                <strong>{{ ingrediente.nombre }}</strong>
                                {% if ingrediente.proveedor %}
                                <small>Prov: {{ ingrediente.proveedor }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td class="stock-actual">{{ ingrediente.stock_actual }}</td>
                        <td class="stock-minimo">{{ ingrediente.stock_minimo }}</td>
                        <td class="unidad">{{ ingrediente.unidad_medida }}</td>
                        <td class="costo">${{ ingrediente.costo_unitario|floatformat:4 }}</td>
                        <td class="valor-total">${{ ingrediente.valor_total|floatformat:2 }}</td>
                        <td class="estado">
                            <span class="status-badge status-{{ ingrediente.estado_stock }}">
                                {% if ingrediente.estado_stock == 'normal' %}
                                    ‚úÖ Normal
                                {% elif ingrediente.estado_stock == 'bajo' %}
                                    ‚ö†Ô∏è Bajo
                                {% else %}
                                    üî¥ Agotado
                                {% endif %}
                            </span>
                        </td>
                        <td class="acciones">
                            <div class="action-buttons-small">
                                <button class="btn-action btn-edit" onclick="openEditIngredienteModal({{ ingrediente.id }})" title="Editar">
                                    <span>‚úèÔ∏è</span>
                                </button>
                                <button class="btn-action btn-ajustar" onclick="openAjustarModal({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')" title="Ajustar Stock">
                                    <span>üìä</span>
                                </button>
                                <button class="btn-action btn-delete" onclick="confirmDeleteIngrediente({{ ingrediente.id }}, '{{ ingrediente.nombre|escapejs }}')" title="Eliminar">
                                    <span>üóëÔ∏è</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="no-data">
                            <div class="empty-state">
                                <div class="empty-icon">üì¶</div>
                                <h3>No hay ingredientes registrados</h3>
                                <p>Comienza agregando tu primer ingrediente al inventario</p>
                                <button class="btn-primary" onclick="openAddIngredienteModal()">
                                    Agregar Primer Ingrediente
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</section>
</div>

<!-- Modal para Agregar Ingrediente -->
<div id="addIngredienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Agregar Nuevo Ingrediente</h2>
            <span class="close" onclick="closeAddIngredienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addIngredienteForm" method="post" action="{% url 'crear_ingrediente' %}" onsubmit="return validateAddIngredienteForm(event)">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="nombre">Nombre del Ingrediente *</label>
                    <input type="text" id="nombre" name="nombre" required class="form-control"
                    pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                    title="Solo se permiten letras y espacios"
                    oninput="validateLettersOnly(this)"
                    placeholder="Ej: Queso Americano">
                    <div class="error-message" id="nombreError"></div>
                </div>

                <div class="form-group">
                    <label for="unidad_medida">Unidad de Medida *</label>
                    <select id="unidad_medida" name="unidad_medida" required class="form-control">
                        <option value="">Selecciona unidad</option>
                        <option value="kg">Kilogramos (kg)</option>
                        <option value="g">Gramos (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                        <option value="unidad">Unidades</option>
                        <option value="lb">Libras (lb)</option>
                    </select>
                    <div class="error-message" id="unidad_medidaError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio_paquete">Precio del Paquete ($) *</label>
                        <input type="number" id="precio_paquete" name="precio_paquete" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="3.99">
                        <div class="error-message" id="precio_paqueteError"></div>
                    </div>
                                    
                    <div class="form-group">
                        <label for="tama√±o_paquete">Tama√±o del Paquete *</label>
                        <input type="number" id="tama√±o_paquete" name="tama√±o_paquete" 
                            step="0.01" min="0.01" required class="form-control"
                            oninput="validatePositiveNumber(this)"
                            placeholder="400">
                        <small class="help-text">En la unidad seleccionada</small>
                        <div class="error-message" id="tama√±o_paqueteError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="stock_actual">Stock Actual *</label>
                        <input type="number" id="stock_actual" name="stock_actual" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="0">
                        <div class="error-message" id="stock_actualError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock_minimo">Stock M√≠nimo *</label>
                        <input type="number" id="stock_minimo" name="stock_minimo" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="10">
                        <div class="error-message" id="stock_minimoError"></div>
                    </div>
                </div>

                <!-- Mostrar c√°lculo autom√°tico -->
                <div class="form-group calculation-display">
                    <label>C√°lculo Autom√°tico:</label>
                    <div id="costo-calculation" class="calculation-result">
                        Costo por unidad: <span id="costo-unitario">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <input type="text" id="proveedor" name="proveedor" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Nombre del proveedor">
                        <div class="error-message" id="proveedorError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ubicacion">Ubicaci√≥n</label>
                        <input type="text" id="ubicacion" name="ubicacion" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Ej: Almac√©n A, Refrigerador">
                        <div class="error-message" id="ubicacionError"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddIngredienteModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Ingrediente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Editar Ingrediente -->
<div id="editIngredienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Ingrediente</h2>
            <span class="close" onclick="closeEditIngredienteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editIngredienteForm" method="post" action="" onsubmit="return validateEditIngredienteForm(event)">
                {% csrf_token %}
                <input type="hidden" id="edit_ingrediente_id" name="ingrediente_id">
                
                <div class="form-group">
                    <label for="edit_nombre">Nombre del Ingrediente *</label>
                    <input type="text" id="edit_nombre" name="nombre" required class="form-control" 
                        pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                        title="Solo se permiten letras y espacios"
                        oninput="validateLettersOnly(this)"
                        placeholder="Nombre del ingrediente">
                    <div class="error-message" id="edit_nombreError"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit_unidad_medida">Unidad de Medida *</label>
                    <select id="edit_unidad_medida" name="unidad_medida" required class="form-control">
                        <option value="">Selecciona unidad</option>
                        <option value="kg">Kilogramos (kg)</option>
                        <option value="g">Gramos (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                        <option value="unidad">Unidades</option>
                        <option value="lb">Libras (lb)</option>
                    </select>
                    <div class="error-message" id="edit_unidad_medidaError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_precio_paquete">Precio del Paquete ($) *</label>
                        <input type="number" id="edit_precio_paquete" name="precio_paquete" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="0.00">
                        <div class="error-message" id="edit_precio_paqueteError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_tama√±o_paquete">Tama√±o del Paquete *</label>
                        <input type="number" id="edit_tama√±o_paquete" name="tama√±o_paquete" 
                            step="0.01" min="0.01" required class="form-control"
                            oninput="validatePositiveNumber(this)"
                            placeholder="1.00">
                        <div class="error-message" id="edit_tama√±o_paqueteError"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_stock_actual">Stock Actual *</label>
                        <input type="number" id="edit_stock_actual" name="stock_actual" 
                            step="0.01" min="0" required class="form-control" 
                            oninput="validateNumber(this)"
                            placeholder="0">
                        <div class="error-message" id="edit_stock_actualError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_stock_minimo">Stock M√≠nimo *</label>
                        <input type="number" id="edit_stock_minimo" name="stock_minimo" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)"
                            placeholder="10">
                        <div class="error-message" id="edit_stock_minimoError"></div>
                    </div>
                </div>

                <!-- Mostrar c√°lculo autom√°tico en edici√≥n -->
                <div class="form-group calculation-display">
                    <label>C√°lculo Autom√°tico:</label>
                    <div class="calculation-result">
                        Costo por unidad: <span id="edit-costo-unitario">$0.00</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_proveedor">Proveedor</label>
                        <input type="text" id="edit_proveedor" name="proveedor" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Nombre del proveedor">
                        <div class="error-message" id="edit_proveedorError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_ubicacion">Ubicaci√≥n</label>
                        <input type="text" id="edit_ubicacion" name="ubicacion" 
                            class="form-control"
                            pattern="[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+"
                            title="Solo se permiten letras y espacios"
                            oninput="validateLettersOnly(this)"
                            placeholder="Ej: Almac√©n A, Refrigerador">
                        <div class="error-message" id="edit_ubicacionError"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditIngredienteModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Actualizar Ingrediente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Ajustar Inventario -->
<div id="ajustarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="ajustarModalTitle">Ajustar Inventario</h2>
            <span class="close" onclick="closeAjustarModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="ajustarForm" method="post" action="" onsubmit="return validateAjusteForm(event)">
                {% csrf_token %}
                <input type="hidden" id="ajustar_ingrediente_id" name="ingrediente_id">
                
                <div class="form-group">
                    <label for="ajustar_nombre">Ingrediente</label>
                    <input type="text" id="ajustar_nombre" readonly class="form-control readonly-input">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="stock_actual_ajuste">Stock Actual</label>
                        <input type="text" id="stock_actual_ajuste" readonly class="form-control readonly-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="cantidad_nueva">Nueva Cantidad *</label>
                        <input type="number" id="cantidad_nueva" name="cantidad_nueva" 
                            step="0.01" min="0" required class="form-control"
                            oninput="validateNumber(this)">
                        <div class="error-message" id="cantidad_nuevaError"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="motivo_ajuste">Motivo del Ajuste *</label>
                    <textarea id="motivo_ajuste" name="motivo" rows="3" required class="form-control" 
                        placeholder="Ej: Conteo f√≠sico, Ajuste por p√©rdida, Correcci√≥n..."></textarea>
                    <div class="error-message" id="motivo_ajusteError"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAjustarModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Aplicar Ajuste</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Formulario oculto para eliminar -->
<form id="deleteIngredienteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<!-- Custom Alert Modal -->
<div id="customAlert" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2 id="alertTitle">Alerta</h2>
            <span class="close" onclick="closeCustomAlert()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="alertMessage"></p>
            <div class="form-actions" style="justify-content: center;">
                <button type="button" class="btn-cancel" onclick="closeCustomAlert()">Cancelar</button>
                <button type="button" class="btn-save" id="alertConfirmBtn">Aceptar</button>
            </div>
        </div>
    </div>
</div>



<script>
// Funciones para los modales
function openAddIngredienteModal() {
    document.getElementById('addIngredienteModal').style.display = 'block';
    document.getElementById('addIngredienteForm').reset();
    clearAllErrors();
}

function closeAddIngredienteModal() {
    document.getElementById('addIngredienteModal').style.display = 'none';
}

function openEditIngredienteModal(ingredienteId) {
    // Cargar datos via AJAX
    fetch(`/inventario/api/ingrediente/${ingredienteId}/`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al cargar los datos');
        }
        return response.json();
    })
    .then(data => {
        // Llenar el formulario del modal con los datos
        document.getElementById('edit_ingrediente_id').value = data.id;
        document.getElementById('edit_nombre').value = data.nombre;
        document.getElementById('edit_unidad_medida').value = data.unidad_medida;
        document.getElementById('edit_precio_paquete').value = data.precio_paquete;
        document.getElementById('edit_tama√±o_paquete').value = data.tama√±o_paquete;
        document.getElementById('edit_stock_actual').value = data.stock_actual;
        document.getElementById('edit_stock_minimo').value = data.stock_minimo;
        document.getElementById('edit_proveedor').value = data.proveedor;
        document.getElementById('edit_ubicacion').value = data.ubicacion;
        
        // Calcular costo unitario para mostrar
        calculateEditUnitCost();
        
        // Actualizar action del form
        document.getElementById('editIngredienteForm').action = `/inventario/ingrediente/editar/${ingredienteId}/`;
        
        // Mostrar modal
        document.getElementById('editIngredienteModal').style.display = 'block';
        clearAllErrors();
    })
    .catch(error => {
        console.error('Error:', error);
        showCustomAlert('Error', 'No se pudieron cargar los datos del ingrediente');
    });
}

function closeEditIngredienteModal() {
    document.getElementById('editIngredienteModal').style.display = 'none';
}

function openAjustarModal(ingredienteId, ingredienteNombre) {
    // Cargar datos via AJAX
    fetch(`/inventario/api/ingrediente/${ingredienteId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('ajustarModal').style.display = 'block';
            document.getElementById('ajustarModalTitle').textContent = `Ajustar ${data.nombre}`;
            document.getElementById('ajustar_nombre').value = data.nombre;
            document.getElementById('ajustar_ingrediente_id').value = data.id;
            document.getElementById('stock_actual_ajuste').value = `${data.stock_actual} ${data.unidad_medida}`;
            document.getElementById('cantidad_nueva').value = data.stock_actual;
            document.getElementById('ajustarForm').action = `/inventario/ajustar/${ingredienteId}/`;
            clearAllErrors();
        })
        .catch(error => {
            console.error('Error:', error);
            showCustomAlert('Error', 'No se pudieron cargar los datos del ingrediente');
        });
}

function closeAjustarModal() {
    document.getElementById('ajustarModal').style.display = 'none';
}

function openHistorialModal() {
    window.location.href = '/inventario/historial/';
}

// Funci√≥n de alerta personalizada
function showCustomAlert(title, message, confirmCallback = null) {
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('customAlert').style.display = 'block';
    
    const confirmBtn = document.getElementById('alertConfirmBtn');
    if (confirmCallback) {
        confirmBtn.onclick = function() {
            confirmCallback();
            closeCustomAlert();
        };
    } else {
        confirmBtn.onclick = closeCustomAlert;
    }
}

function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
}

// Funciones de validaci√≥n
function validateLettersOnly(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById(input.id + 'Error');
    const lettersOnly = /^[A-Za-z√Å√°√â√©√ç√≠√ì√≥√ö√∫√ë√±\s]+$/;
    
    if (input.required && !value) {
        showError(input, errorElement, 'Este campo es obligatorio');
        return false;
    }
    
    if (value && !lettersOnly.test(value)) {
        showError(input, errorElement, 'Solo se permiten letras y espacios');
        return false;
    }
    
    hideError(input, errorElement);
    return true;
}

function validateNumber(input) {
    const value = parseFloat(input.value);
    const errorElement = document.getElementById(input.id + 'Error');
    
    if (!input.value) {
        showError(input, errorElement, 'Este campo es obligatorio');
        return false;
    }
    
    if (isNaN(value) || value < 0) {
        showError(input, errorElement, 'Debe ser un n√∫mero v√°lido mayor o igual a 0');
        return false;
    }
    
    hideError(input, errorElement);
    
    // Calcular costo unitario autom√°ticamente
    if (input.id.includes('precio') || input.id.includes('tama√±o')) {
        if (input.id.includes('edit')) {
            calculateEditUnitCost();
        } else {
            calculateUnitCost();
        }
    }
    return true;
}

function validatePositiveNumber(input) {
    const value = parseFloat(input.value);
    const errorElement = document.getElementById(input.id + 'Error');
    
    if (!input.value) {
        showError(input, errorElement, 'Este campo es obligatorio');
        return false;
    }
    
    if (isNaN(value) || value <= 0) {
        showError(input, errorElement, 'Debe ser un n√∫mero mayor a 0');
        return false;
    }
    
    hideError(input, errorElement);
    
    // Calcular costo unitario autom√°ticamente
    if (input.id.includes('precio') || input.id.includes('tama√±o')) {
        if (input.id.includes('edit')) {
            calculateEditUnitCost();
        } else {
            calculateUnitCost();
        }
    }
    return true;
}

function validateUnidadMedida(select) {
    const errorElement = document.getElementById(select.id + 'Error');
    
    if (!select.value) {
        showError(select, errorElement, 'Debes seleccionar una unidad de medida');
        return false;
    }
    
    hideError(select, errorElement);
    return true;
}

function validateTextArea(textarea) {
    const errorElement = document.getElementById(textarea.id + 'Error');
    
    if (!textarea.value.trim()) {
        showError(textarea, errorElement, 'Este campo es obligatorio');
        return false;
    }
    
    hideError(textarea, errorElement);
    return true;
}

// Calcular costo unitario autom√°ticamente - AGREGAR
function calculateUnitCost() {
    const precio = parseFloat(document.getElementById('precio_paquete')?.value) || 0;
    const tama√±o = parseFloat(document.getElementById('tama√±o_paquete')?.value) || 1;
    
    if (precio > 0 && tama√±o > 0) {
        const costoUnitario = precio / tama√±o;
        document.getElementById('costo-unitario').textContent = `$${costoUnitario.toFixed(6)}`;
    } else {
        document.getElementById('costo-unitario').textContent = '$0.00';
    }
}

// Calcular costo unitario autom√°ticamente - EDITAR
function calculateEditUnitCost() {
    const precio = parseFloat(document.getElementById('edit_precio_paquete')?.value) || 0;
    const tama√±o = parseFloat(document.getElementById('edit_tama√±o_paquete')?.value) || 1;
    
    if (precio > 0 && tama√±o > 0) {
        const costoUnitario = precio / tama√±o;
        document.getElementById('edit-costo-unitario').textContent = `$${costoUnitario.toFixed(6)}`;
    } else {
        document.getElementById('edit-costo-unitario').textContent = '$0.00';
    }
}

// Funciones para mostrar/ocultar errores
function showError(input, errorElement, message) {
    input.style.borderColor = '#e74c3c';
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

function hideError(input, errorElement) {
    input.style.borderColor = '#e0e0e0';
    if (errorElement) {
        errorElement.style.display = 'none';
    }
}

function clearAllErrors() {
    // Limpiar todos los mensajes de error
    const errorMessages = document.querySelectorAll('.error-message');
    errorMessages.forEach(error => {
        error.style.display = 'none';
    });
    
    // Restablecer bordes de los inputs
    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
        input.style.borderColor = '#e0e0e0';
    });
}

// Validaci√≥n completa del formulario AGREGAR
function validateAddIngredienteForm(event) {
    const nombre = document.getElementById('nombre');
    const unidadMedida = document.getElementById('unidad_medida');
    const precio = document.getElementById('precio_paquete');
    const tama√±o = document.getElementById('tama√±o_paquete');
    const stockActual = document.getElementById('stock_actual');
    const stockMinimo = document.getElementById('stock_minimo');
    const proveedor = document.getElementById('proveedor');
    const ubicacion = document.getElementById('ubicacion');
    
    clearAllErrors();
    
    let isValid = true;
    
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateUnidadMedida(unidadMedida)) isValid = false;
    if (!validateNumber(precio)) isValid = false;
    if (!validatePositiveNumber(tama√±o)) isValid = false;
    if (!validateNumber(stockActual)) isValid = false;
    if (!validateNumber(stockMinimo)) isValid = false;
    if (proveedor.value && !validateLettersOnly(proveedor)) isValid = false;
    if (ubicacion.value && !validateLettersOnly(ubicacion)) isValid = false;
    
    if (!isValid) {
        event.preventDefault();
        showCustomAlert('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.');
        return false;
    }
    
    return true;
}

// Validaci√≥n completa del formulario EDITAR
function validateEditIngredienteForm(event) {
    const nombre = document.getElementById('edit_nombre');
    const unidadMedida = document.getElementById('edit_unidad_medida');
    const precio = document.getElementById('edit_precio_paquete');
    const tama√±o = document.getElementById('edit_tama√±o_paquete');
    const stockActual = document.getElementById('edit_stock_actual');
    const stockMinimo = document.getElementById('edit_stock_minimo');
    const proveedor = document.getElementById('edit_proveedor');
    const ubicacion = document.getElementById('edit_ubicacion');
    
    clearAllErrors();
    
    let isValid = true;
    
    if (!validateLettersOnly(nombre)) isValid = false;
    if (!validateUnidadMedida(unidadMedida)) isValid = false;
    if (!validateNumber(precio)) isValid = false;
    if (!validatePositiveNumber(tama√±o)) isValid = false;
    if (!validateNumber(stockActual)) isValid = false;
    if (!validateNumber(stockMinimo)) isValid = false;
    if (proveedor.value && !validateLettersOnly(proveedor)) isValid = false;
    if (ubicacion.value && !validateLettersOnly(ubicacion)) isValid = false;
    
    if (!isValid) {
        event.preventDefault();
        showCustomAlert('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.');
        return false;
    }
    
    return true;
}

function validateAjusteForm(event) {
    const cantidadNueva = document.getElementById('cantidad_nueva');
    const motivo = document.getElementById('motivo_ajuste');
    
    clearAllErrors();
    
    let isValid = true;
    
    if (!validateNumber(cantidadNueva)) isValid = false;
    if (!validateTextArea(motivo)) isValid = false;
    
    if (!isValid) {
        event.preventDefault();
        showCustomAlert('Error de Validaci√≥n', 'Por favor corrige los errores en el formulario.');
        return false;
    }
    
    return true;
}

// Funciones de eliminaci√≥n
function confirmDeleteIngrediente(ingredienteId, ingredienteNombre) {
    showCustomAlert(
        'Confirmar Eliminaci√≥n',
        `¬øEst√°s seguro de que quieres eliminar el ingrediente "${ingredienteNombre}"?`,
        function() {
            const form = document.getElementById('deleteIngredienteForm');
            form.action = `/inventario/ingrediente/eliminar/${ingredienteId}/`;
            form.submit();
        }
    );
}

// Cerrar modales al hacer clic fuera
window.addEventListener('click', function(event) {
    const modals = [
        'addIngredienteModal', 
        'editIngredienteModal', 
        'ajustarModal',
        'customAlert'
    ];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});

// Cerrar modales con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = [
            'addIngredienteModal', 
            'editIngredienteModal', 
            'ajustarModal',
            'customAlert'
        ];
        
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        });
    }
});

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema de inventario BullBurger cargado correctamente üì¶');
    
    // Agregar efectos hover a las filas de la tabla
    const tableRows = document.querySelectorAll('.data-row');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });
    
    // Inicializar c√°lculos
    document.getElementById('precio_paquete')?.addEventListener('input', calculateUnitCost);
    document.getElementById('tama√±o_paquete')?.addEventListener('input', calculateUnitCost);
    document.getElementById('edit_precio_paquete')?.addEventListener('input', calculateEditUnitCost);
    document.getElementById('edit_tama√±o_paquete')?.addEventListener('input', calculateEditUnitCost);
});
</script>
{% endblock %}
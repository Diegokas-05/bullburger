{% extends 'base.html' %}
{% load static %}

{% block title %}Men√∫ - BullBurger{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/cliente_style.css' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<section class="cliente-bg">
  <h1 class="titulo-menu">Men√∫ BullBurger üçî</h1>

  <!-- Categor√≠as -->
  <div class="categorias">
    <button class="categoria activo" data-category="all">
      <span>üçΩÔ∏è Todos</span>
    </button>
    {% for categoria in categorias %}
      <button class="categoria" data-category="{{ categoria.id }}">
        <span>
          {% if categoria.nombre == 'Hamburguesas' %}üçî
          {% elif categoria.nombre == 'Bebidas' %}ü•§
          {% elif categoria.nombre == 'Snacks' %}üçü
          {% elif categoria.nombre == 'Combos' %}üì¶
          {% elif categoria.nombre == 'Postres' %}üç¶
          {% else %}üçΩÔ∏è{% endif %}
          {{ categoria.nombre }}
        </span>
      </button>
    {% endfor %}
  </div>

  <!-- Productos -->
  <div class="products-grid">
    {% for producto in productos %}
    <div class="product-card" data-category="{{ producto.categoria.id }}"
         onclick="openModal('{{ producto.nombre }}', '{{ producto.descripcion|escapejs }}', '{{ producto.precio }}', '{% if producto.imagen %}{{ producto.imagen.url }}{% elif producto.imagen_url %}{{ producto.imagen_url }}{% endif %}', '{{ producto.id }}')">

      <div class="product-image">
        {% if producto.imagen %}
          <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
        {% elif producto.imagen_url %}
          <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}">
        {% else %}
          <div class="image-placeholder">üçî</div>
        {% endif %}
      </div>

      <div class="product-info">
        <h3>{{ producto.nombre }}</h3>
        <p class="product-description">{{ producto.descripcion|default:"Sin descripci√≥n" }}</p>
        <div class="product-price">${{ producto.precio }}</div>
        <div class="product-category">
          <small>Categor√≠a: {{ producto.categoria.nombre }}</small>
        </div>
      </div>
    </div>
    {% empty %}
      <div class="no-products">
        <h3>No hay productos en el men√∫</h3>
        <p>Haz clic en "Agregar Nuevo Producto" para comenzar</p>
      </div>
    {% endfor %}
  </div>
</section>

<!-- Modal del producto -->
<div id="productoModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>

    <div class="modal-body">
      <img id="modalImagen" src="" alt="Producto" class="modal-img">
      <div class="modal-info">
        <h2 id="modalNombre"></h2>
        <p id="modalDescripcion"></p>
        <p class="modal-precio">Precio: <span id="modalPrecio"></span></p>

        <label for="modalCantidad">Cantidad:</label>
        <input type="number" id="modalCantidad" value="1" min="1" step="1">

        <div class="modal-buttons">
          <button onclick="agregarAlCarrito()">Agregar a la bolsa</button>
          <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const categoryButtons = document.querySelectorAll('.categoria');
  const productos = document.querySelectorAll('.product-card');

  categoryButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryButtons.forEach(b => b.classList.remove('activo'));
      btn.classList.add('activo');
      const categoria = btn.getAttribute('data-category');

      productos.forEach(prod => {
        if (categoria === 'all' || prod.getAttribute('data-category') === categoria) {
          prod.style.display = 'block';
        } else {
          prod.style.display = 'none';
        }
      });
    });
  });
});

let productoSeleccionado = null;

function openModal(nombre, descripcion, precio, imagen, id) {
  productoSeleccionado = { id, nombre, precio };
  document.getElementById('modalNombre').textContent = nombre;
  document.getElementById('modalDescripcion').textContent = descripcion || 'Sin descripci√≥n';
  document.getElementById('modalPrecio').textContent = `$${precio}`;
  document.getElementById('modalImagen').src = imagen;
  document.getElementById('modalCantidad').value = 1;
  document.getElementById('productoModal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('productoModal').style.display = 'none';
}

function agregarAlCarrito() {
  const cantidad = document.getElementById('modalCantidad').value;

  fetch('/carrito/agregar/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({
      producto_id: productoSeleccionado.id,
      cantidad: cantidad
    })
  })
  .then(res => res.json())
  .then(data => {
    closeModal();
    if (data.ok) {
      Swal.fire({
        title: '¬°Producto a√±adido!',
        text: `${productoSeleccionado.nombre} fue agregado a tu carrito.`,
        icon: 'success',
        showCancelButton: true,
        confirmButtonColor: '#27ae60',
        cancelButtonColor: '#f4c542',
        confirmButtonText: 'Ver bolsa',
        cancelButtonText: 'Seguir comprando',
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/cliente/carrito/';
        }
      });
    } else {
      Swal.fire('Error', data.error || 'No se pudo a√±adir el producto', 'error');
    }
  })
  .catch(() => Swal.fire('Error', 'Error en la solicitud al servidor', 'error'));
}

// Evitar valores inv√°lidos en cantidad
document.addEventListener("input", (e) => {
  if (e.target.id === "modalCantidad") {
    let val = parseInt(e.target.value);
    if (isNaN(val) || val < 1) {
      e.target.value = 1;
    }
  }
});

</script>
{% endblock %}

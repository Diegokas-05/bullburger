{% extends 'base.html' %}
{% load static %}

{% block title %}MenÃº - BullBurger{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/cliente_style.css' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<section class="cliente-bg">

  <h1 class="titulo-menu">MenÃº BullBurger ğŸ”</h1>

  <!-- ============================================================
       =============== BOTONES DE CATEGORÃA ========================
       ============================================================ -->
  <div class="categorias">
    <button class="categoria activo" data-category="all">
      <span>ğŸ½ï¸ Todos</span>
    </button>

    {% for categoria in categorias %}
      <button class="categoria" data-category="{{ categoria.id }}">
        <span>
          {% if categoria.nombre == 'Hamburguesas' %}ğŸ”
          {% elif categoria.nombre == 'Bebidas' %}ğŸ¥¤
          {% elif categoria.nombre == 'Snacks' %}ğŸŸ
          {% elif categoria.nombre == 'Combos' %}ğŸ“¦
          {% elif categoria.nombre == 'Postres' %}ğŸ¦
          {% else %}ğŸ½ï¸{% endif %}
          {{ categoria.nombre }}
        </span>
      </button>
    {% endfor %}
  </div>

  <!-- ============================================================
       ===================== PRODUCTOS =============================
       ============================================================ -->
  <div class="products-grid">

    {% for producto in productos %}
    <!-- Cada tarjeta tiene data-id para actualizar stock en vivo -->
    <div class="product-card"
         data-category="{{ producto.categoria.id }}"
         data-id="{{ producto.id }}"
         onclick="openModal(
            '{{ producto.nombre }}',
            '{{ producto.descripcion|escapejs }}',
            '{{ producto.precio }}',
            '{% if producto.imagen %}{{ producto.imagen.url }}{% elif producto.imagen_url %}{{ producto.imagen_url }}{% endif %}',
            '{{ producto.stock_disponible }}',
            '{{ producto.id }}')">

      <div class="product-image">
        {% if producto.imagen %}
          <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
        {% elif producto.imagen_url %}
          <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}">
        {% else %}
          <div class="image-placeholder">
            {% if producto.categoria.nombre == 'Hamburguesas' %}ğŸ”
            {% elif producto.categoria.nombre == 'Bebidas' %}ğŸ¥¤
            {% elif producto.categoria.nombre == 'Snacks' %}ğŸŸ
            {% elif producto.categoria.nombre == 'Combos' %}ğŸ“¦
            {% elif producto.categoria.nombre == 'Postres' %}ğŸ¦
            {% else %}ğŸ½ï¸{% endif %}
          </div>
        {% endif %}
      </div>

      <div class="product-info">
        <h3>
          {% if producto.categoria.nombre == 'Hamburguesas' %}ğŸ”
          {% elif producto.categoria.nombre == 'Bebidas' %}ğŸ¥¤
          {% elif producto.categoria.nombre == 'Snacks' %}ğŸŸ
          {% elif producto.categoria.nombre == 'Combos' %}ğŸ“¦
          {% elif producto.categoria.nombre == 'Postres' %}ğŸ¦
          {% else %}ğŸ½ï¸{% endif %}
          {{ producto.nombre }}
        </h3>

        <p class="product-description">{{ producto.descripcion|default:"Sin descripciÃ³n" }}</p>

        <div class="product-price">${{ producto.precio }}</div>

        <!-- STOCK EN TARJETA -->
        <div class="stock-label">
          {% if producto.stock_disponible > 10 %}
              <small class="stock-ok">Disponible</small>
          {% elif producto.stock_disponible > 0 %}
              <small class="stock-low">Quedan {{ producto.stock_disponible }}</small>
          {% else %}
              <small class="stock-zero">AGOTADO</small>
          {% endif %}
        </div>

        <div class="product-category">
          <small>CategorÃ­a: {{ producto.categoria.nombre }}</small>
        </div>
      </div>
    </div>
    {% endfor %}

  </div>
</section>

<!-- ============================================================
     ======================== MODAL ===============================
     ============================================================ -->
<div id="productoModal" class="modal" style="display:none;">
  <div class="modal-content">

    <span class="close" onclick="closeModal()">&times;</span>

    <div class="modal-body">

      <img id="modalImagen" class="modal-img" alt="Producto">

      <div class="modal-info">
        <h2 id="modalNombre"></h2>
        <p id="modalDescripcion"></p>

        <p class="modal-precio">
            Precio: <span id="modalPrecio"></span>
        </p>

        <!-- STOCK EN EL MODAL -->
        <p id="modalStock" class="modal-stock-text"></p>

        <label for="modalCantidad">Cantidad:</label>
        <input type="number" id="modalCantidad" value="1" min="1" step="1">

        <div class="modal-buttons">
          <button onclick="agregarAlCarrito()">Agregar a la bolsa</button>
          <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- ============================================================
     ====================== SCRIPTS ===============================
     ============================================================ -->
<script>

  /* ==========================================
     FILTRO DE CATEGORÃAS
     ========================================== */
  document.addEventListener('DOMContentLoaded', () => {
    const categoryButtons = document.querySelectorAll('.categoria');
    const productos = document.querySelectorAll('.product-card');

    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryButtons.forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');

        const categoria = btn.dataset.category;

        productos.forEach(prod => {
          prod.style.display = (categoria === 'all' ||
                                prod.dataset.category === categoria)
                                ? 'block' : 'none';
        });
      });
    });
  });


  let productoSeleccionado = null;

  /* ==========================================
     ABRIR MODAL CON STOCK
     ========================================== */
  function openModal(nombre, descripcion, precio, imagen, stock, id) {
    productoSeleccionado = { id, nombre, precio };

    document.getElementById('modalNombre').textContent = nombre;
    document.getElementById('modalDescripcion').textContent = descripcion;
    document.getElementById('modalPrecio').textContent = "$" + precio;
    document.getElementById('modalImagen').src = imagen;
    document.getElementById('modalCantidad').value = 1;

    // ğŸŸ¢ MOSTRAR STOCK REAL EN EL MODAL
    const stockText = document.getElementById("modalStock");
    stockText.textContent = `Stock disponible: ${stock}`;
    stockText.style.fontWeight = "bold";
    stockText.style.marginTop = "10px";

    document.getElementById('productoModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('productoModal').style.display = 'none';
  }

  /* ==========================================
     AGREGAR AL CARRITO + ACTUALIZAR STOCK
     ========================================== */
  function agregarAlCarrito() {
    const cantidad = document.getElementById('modalCantidad').value;

    fetch('/carrito/agregar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        producto_id: productoSeleccionado.id,
        cantidad: cantidad
      })
    })
    .then(res => res.json())
    .then(data => {

      if (!data.ok) {
        Swal.fire("Error", data.error, "error");
        return;
      }

      closeModal();

      // ğŸ”¥ ACTUALIZAR STOCK EN TIEMPO REAL
      if (data.ok) {
    Swal.fire({
        title: 'Â¡Producto aÃ±adido!',
        text: `${productoSeleccionado.nombre} fue agregado a tu carrito.`,
        icon: 'success',
        showCancelButton: true,
        confirmButtonColor: '#27ae60',
        cancelButtonColor: '#f4c542',
        confirmButtonText: 'Ver bolsa',
        cancelButtonText: 'Seguir comprando'
    }).then(res => {
        if (res.isConfirmed) {
            // Ir al carrito
            window.location.href = '/cliente/carrito/';
        } else {
            // Recargar pÃ¡gina para actualizar stock REAL
            window.location.reload();
        }
    });
}

    });
  }

  /* ==========================================
     ACTUALIZAR STOCK VISUAL EN TARJETAS
     ========================================== */
  function actualizarStockFront(stockMap) {

    document.querySelectorAll(".product-card").forEach(card => {
      const id = parseInt(card.dataset.id);
      const disponible = stockMap[id] ?? 0;

      const label = card.querySelector(".stock-label small");

      // Cambiar texto de stock
      if (disponible > 10) {
        label.textContent = "Disponible";
        label.className = "stock-ok";
      }
      else if (disponible > 0) {
        label.textContent = `Quedan ${disponible}`;
        label.className = "stock-low";
      }
      else {
        label.textContent = "AGOTADO";
        label.className = "stock-zero";

        // ğŸ”¥ SE DESACTIVA LA TARJETA COMPLETA
        card.style.opacity = "0.4";
        card.style.pointerEvents = "none";
        card.style.filter = "grayscale(100%)";
      }
    });
  }

</script>

{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Carrito - BullBurger{% endblock %}

{% block content %}
{% csrf_token %}

<link rel="stylesheet" href="{% static 'css/cliente/carrito.css' %}">

<section class="cliente-bg">
  <div class="carrito-container">
    
    <header class="carrito-header">
      <h1 class="titulo">MI BOLSA
        <p class="subtitulo">Est√°s a un paso de disfrutar</p>
      </h1>
      
    </header>

    {% if pedidos %}
      <div class="carrito-grid">
        
        <div class="lista-productos">
          {% for item in pedidos %}
            <div class="carrito-item" id="item-{{ item.id }}">
              
              <div class="img-wrapper">
                {% if item.producto.imagen %}
                  <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}">
                {% elif item.producto.imagen_url %}
                  <img src="{{ item.producto.imagen_url }}" alt="{{ item.producto.nombre }}">
                {% else %}
                  <img src="{% static 'img/placeholder.png' %}" alt="Sin imagen">
                {% endif %}
              </div>

              <div class="item-detalles">
                <div class="info-top">
                  <h3>{{ item.producto.nombre }}</h3>
                  <p class="desc">{{ item.producto.descripcion|default:"Una deliciosa elecci√≥n."|truncatechars:60 }}</p>
                </div>
                
                <div class="info-bottom">
                  <span class="precio">${{ item.producto.precio }}</span>
                  <p class="stock-info">Stock: {{ item.producto.stock }}</p>
                </div>
              </div>

              <div class="item-controles">
                <label for="cantidad-{{ item.id }}">Cantidad</label>
                <div class="input-group">
                   <input 
                     type="number"
                     id="cantidad-{{ item.id }}"
                     value="{{ item.cantidad }}"
                     min="1"
                     max="{{ item.producto.stock }}"
                     data-stock="{{ item.producto.stock }}"
                     class="input-cantidad"
                     oninput="validarCantidad('{{ item.id }}')"
                   >
                   <button class="btn-icon btn-update" onclick="editarCantidad('{{ item.id }}')" title="Actualizar cantidad">
                     <i class="fas fa-sync-alt"></i> ‚Üª
                   </button>
                </div>
                
                <button class="btn-eliminar-texto" onclick="eliminarItem('{{ item.id }}')">
                  Eliminar
                </button>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="resumen-pago">
          <div class="resumen-card">
            <h3>Resumen</h3>
            <div class="resumen-row">
              <span>Subtotal</span>
              <span>${{ total }}</span>
            </div>
            <div class="resumen-row total-row">
              <span>Total</span>
              <span id="total-display">${{ total }}</span>
            </div>
            <button id="btnPagar" class="btn-pagar">IR A PAGAR ‚ûù</button>
            <a href="{% url 'menu_cliente' %}" class="btn-seguir-comprando">Seguir pidiendo</a>
          </div>
        </div>

      </div>

    {% else %}
      <div class="carrito-vacio">
        <div class="icono-vacio">üõí</div>
        <h2>Tu bolsa est√° vac√≠a</h2>
        <p>¬°Nuestras hamburguesas te extra√±an!</p>
        <a href="{% url 'menu_cliente' %}" class="btn-volver">Ver Men√∫</a>
      </div>
    {% endif %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

/* ===========================
   VALIDAR CANTIDAD (FRONTEND)
=========================== */
function validarCantidad(id) {
    const input = document.getElementById(`cantidad-${id}`);
    const maxStock = parseInt(input.dataset.stock);

    // Evitar negativos
    if (input.value < 1) input.value = 1;

    // Evitar sobrepasar existencias
    if (input.value > maxStock) {
        input.value = maxStock;
        input.classList.add("shake");

        setTimeout(() => input.classList.remove("shake"), 500);
    }
}

/* ===========================
   ACTUALIZAR CANTIDAD
=========================== */
function editarCantidad(id) {
  const input = document.getElementById(`cantidad-${id}`);
  const maxStock = parseInt(input.dataset.stock);
  let nuevaCantidad = parseInt(input.value);

  // Validar negativos
  if (!nuevaCantidad || nuevaCantidad < 1) {
    input.value = 1;
    nuevaCantidad = 1;
  }

  // Validar stock
  if (nuevaCantidad > maxStock) {
    input.classList.add("shake");

    Swal.fire({
      icon: 'warning',
      title: 'Stock insuficiente',
      text: `Solo hay ${maxStock} unidades disponibles`,
      confirmButtonColor: '#b71c1c'
    });

    input.value = maxStock;

    setTimeout(() => input.classList.remove("shake"), 600);
    return;
  }

  // Enviar al backend
  fetch(`/carrito/editar/${id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ cantidad: nuevaCantidad })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      Swal.fire({
        title: 'Cantidad actualizada',
        icon: 'success',
        timer: 1200,
        showConfirmButton: false
      }).then(() => location.reload());
    } else {
      Swal.fire('Error', data.error, 'error');
      setTimeout(() => location.reload(), 1200);
    }
  });
}


/* ===========================
   ELIMINAR ITEM
=========================== */
function eliminarItem(id) {
  Swal.fire({
    title: '¬øEliminar producto?',
    text: 'Se eliminar√° de tu bolsa.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/carrito/eliminar/${id}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          Swal.fire({
            title: 'Eliminado',
            text: 'El producto se elimin√≥ correctamente.',
            icon: 'success',
            timer: 1200,
            showConfirmButton: false
          }).then(() => location.reload());
        } else {
          Swal.fire('Error', data.error, 'error');
        }
      });
    }
  });
}


/* ===========================
   MODAL DE PAGO (VISUAL MEJORADO + MISMA L√ìGICA)
=========================== */
document.getElementById('btnPagar')?.addEventListener('click', async () => {
  const { value: formValues } = await Swal.fire({
    title: 'Confirmar Pedido',
    customClass: { popup: 'bb-checkout' },
    // AQUI ES DONDE MEJORAMOS EL DISE√ëO HTML CON ICONOS
    html: `
      <div class="bb-grid">
        
        <div class="bb-card">
          <div class="bb-h2"><i class="fas fa-truck"></i> Entrega</div>
          
          <label class="bb-label">¬øC√≥mo quieres recibirlo?</label>
          <div class="bb-radio" id="bb-entrega">
            <label>
                <input type="radio" name="bb-entrega" value="local" checked> 
                <span><i class="fas fa-store"></i> Recoger en local</span>
            </label>
            <label>
                <input type="radio" name="bb-entrega" value="domicilio"> 
                <span><i class="fas fa-motorcycle"></i> Env√≠o a domicilio</span>
            </label>
          </div>

          <div id="bb-direccion-wrap" style="margin-top:15px; display:none; animation: fadeIn 0.3s;">
            <label class="bb-label"><i class="fas fa-map-marker-alt"></i> Direcci√≥n exacta</label>
            <textarea id="bb-direccion" class="bb-textarea" placeholder="Ej: Calle Principal #123, Col. Centro (Port√≥n negro)"></textarea>
          </div>
        </div>

        <div class="bb-card">
          <div class="bb-h2"><i class="fas fa-user-check"></i> Tus Datos</div>

          <label class="bb-label">Nombre completo</label>
          <div style="position:relative;">
             <i class="fas fa-user" style="position:absolute; left:10px; top:13px; color:#ccc;"></i>
             <input id="swal-nombre" class="bb-input" style="padding-left: 30px;" value="{{ request.user.nombre|default:'' }}" disabled>
          </div>

          <label class="bb-label">Tel√©fono de contacto</label>
          <div style="position:relative;">
             <i class="fas fa-phone" style="position:absolute; left:10px; top:13px; color:#ccc;"></i>
             
             <input id="swal-telefono" class="bb-input" style="padding-left: 30px;" 
                    value="{{ request.user.telefono|default:'' }}" 
                    placeholder="####-####">
          </div>

          <label class="bb-label">M√©todo de pago</label>
          <select id="swal-metodo" class="bb-select">
            <option value="efectivo">üíµ Efectivo</option>
            <option value="tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
          </select>

          <div id="bb-numero-tarjeta-wrap" style="margin-top:15px; display:none; animation: fadeIn 0.3s;">
            <label class="bb-label">N√∫mero de tarjeta</label>
            <input id="bb-numero-tarjeta" class="bb-input" placeholder="0000 0000 0000 0000" inputmode="numeric" maxlength="19">
            <div class="bb-muted"><i class="fas fa-lock"></i> Transacci√≥n segura (12-19 d√≠gitos)</div>
          </div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Confirmar y Pedir <i class="fas fa-arrow-right"></i>',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#27ae60',
    cancelButtonColor: '#7f8c8d',
    focusConfirm: false,
    
    // --- TU L√ìGICA EXACTA (SIN CAMBIOS FUNCIONALES) ---
    didOpen: () => {

      // Cambios de entrega
      const entregaWrap = document.getElementById('bb-entrega');
      const direccionWrap = document.getElementById('bb-direccion-wrap');

      const toggleEntrega = () => {
        const valor = entregaWrap.querySelector('input:checked').value;
        direccionWrap.style.display = valor === 'domicilio' ? 'block' : 'none';
      };
      entregaWrap.addEventListener('change', toggleEntrega);
      toggleEntrega();

      // Pago
      const metodoSel = document.getElementById('swal-metodo');
      const tarjetaWrap = document.getElementById('bb-numero-tarjeta-wrap');
      metodoSel.addEventListener('change', () => {
        tarjetaWrap.style.display = metodoSel.value === 'tarjeta' ? 'block' : 'none';
      });

      // üîπ FORMATEO DE TEL√âFONO: 1234-5678
      const telInput = document.getElementById('swal-telefono');
      if (telInput) {
        // Si el usuario no tiene tel, lo habilitamos para escribir
        if(!telInput.disabled) {
            telInput.setAttribute('inputmode', 'numeric');
            telInput.setAttribute('maxlength', '9'); 
    
            const formatPhoneSwal = (el) => {
              let digits = el.value.replace(/\D/g, '').slice(0, 8);
              if (digits.length > 4) {
                el.value = digits.slice(0, 4) + '-' + digits.slice(4);
              } else {
                el.value = digits;
              }
            };
    
            formatPhoneSwal(telInput);
            telInput.addEventListener('input', () => formatPhoneSwal(telInput));
        }
      }
    },
    preConfirm: () => {
      const nombre = document.getElementById('swal-nombre').value.trim();
      const telefono = document.getElementById('swal-telefono').value.trim();
      const entrega = document.querySelector('input[name="bb-entrega"]:checked').value;
      const metodo = document.getElementById('swal-metodo').value;
      const direccion = document.getElementById('bb-direccion').value.trim();
      const tarjeta = document.getElementById('bb-numero-tarjeta').value.trim();

      if (!nombre) return Swal.showValidationMessage("El nombre es obligatorio");
      if (!telefono || telefono.length < 9) return Swal.showValidationMessage("Ingresa un tel√©fono v√°lido (####-####)");
      
      if (entrega === 'domicilio' && !direccion)
        return Swal.showValidationMessage("Por favor ingresa la direcci√≥n de entrega");
      
      if (metodo === 'tarjeta' && (tarjeta.length < 12 || tarjeta.length > 19))
        return Swal.showValidationMessage("N√∫mero de tarjeta inv√°lido");

      return { nombre, telefono, entrega, metodo, direccion, numero_pago: tarjeta };
    }
  });

  if (!formValues) return;

  // --- ENV√çO AL BACKEND (SIN CAMBIOS) ---
  const resp = await fetch("{% url 'carrito_checkout' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify(formValues)
  });
  const data = await resp.json();

  if (data.ok) {
    await Swal.fire({
      icon: 'success',
      title: '¬°Pedido Recibido!',
      html: `
        <div style="text-align:center;">
            <p style="font-size:1.1rem;">Tu orden ha sido confirmada.</p>
            <p style="font-size:1.4rem; font-weight:bold; color:#27ae60;">Total: $${data.total}</p>
            <br>
            ${data.factura_url ? `<a href="${data.factura_url}" target="_blank" class="btn-factura" style="background:#2c3e50; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;">üìÑ Descargar Factura</a>` : ''}
        </div>
      `,
      confirmButtonColor: '#27ae60',
      confirmButtonText: 'Excelente'
    });

    location.reload();
  } else {
    Swal.fire({
        title: 'Ups...',
        text: data.error,
        icon: 'error',
        confirmButtonColor: '#d33'
    });
  }
});

</script>

{% endblock %}

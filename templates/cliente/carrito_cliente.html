{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Carrito - BullBurger{% endblock %}

{% block content %}
{% csrf_token %}

<link rel="stylesheet" href="{% static 'css/cliente/carrito.css' %}">

<section class="cliente-bg">
  <h1 class="titulo"> MI BOLSA</h1>

  {% if pedidos %}
    {% for item in pedidos %}
      <div class="carrito-item">

        <!-- Imagen -->
        {% if item.producto.imagen %}
          <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="item-img">
        {% elif item.producto.imagen_url %}
          <img src="{{ item.producto.imagen_url }}" alt="{{ item.producto.nombre }}" class="item-img">
        {% else %}
          <img src="{% static 'img/placeholder.png' %}" alt="{{ item.producto.nombre }}" class="item-img">
        {% endif %}

        <!-- INFO -->
        <div class="item-info">
          <h3>{{ item.producto.nombre }}</h3>
          <p class="item-descripcion">{{ item.producto.descripcion|default:"Sin descripci√≥n" }}</p>
          <p class="item-precio">${{ item.producto.precio }}</p>

          <div class="cantidad-container">
            <label for="cantidad-{{ item.id }}">Cantidad:</label>

            <!-- INPUT CONTROLADO -->
            <input 
              type="number"
              id="cantidad-{{ item.id }}"
              value="{{ item.cantidad }}"
              min="1"
              max="{{ item.producto.stock }}"
              data-stock="{{ item.producto.stock }}"
              class="input-cantidad"
              oninput="validarCantidad('{{ item.id }}')"
            >

            <p class="stock-info">Disponibles: {{ item.producto.stock }}</p>

            <div class="acciones-container">
              <button class="btn-editar" onclick="editarCantidad('{{ item.id }}')">Actualizar</button>
              <button class="btn-eliminar" onclick="eliminarItem('{{ item.id }}')">Eliminar</button>
            </div>

          </div>
        </div>
      </div>
    {% endfor %}

    <div class="carrito-total">
      <p>Total: <span id="total">${{ total }}</span></p>
      <button id="btnPagar" class="btn-pagar">PAGAR BOLSA</button>
    </div>

  {% else %}
    <div class="carrito-vacio">
      <h2>üõí Tu bolsa est√° vac√≠a</h2>
      <a href="{% url 'menu_cliente' %}" class="btn-volver">Volver al men√∫</a>
    </div>
  {% endif %}
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

/* ===========================
   VALIDAR CANTIDAD (FRONTEND)
=========================== */
function validarCantidad(id) {
    const input = document.getElementById(`cantidad-${id}`);
    const maxStock = parseInt(input.dataset.stock);

    // Evitar negativos
    if (input.value < 1) input.value = 1;

    // Evitar sobrepasar existencias
    if (input.value > maxStock) {
        input.value = maxStock;
        input.classList.add("shake");

        setTimeout(() => input.classList.remove("shake"), 500);
    }
}

/* ===========================
   ACTUALIZAR CANTIDAD
=========================== */
function editarCantidad(id) {
  const input = document.getElementById(`cantidad-${id}`);
  const maxStock = parseInt(input.dataset.stock);
  let nuevaCantidad = parseInt(input.value);

  // Validar negativos
  if (!nuevaCantidad || nuevaCantidad < 1) {
    input.value = 1;
    nuevaCantidad = 1;
  }

  // Validar stock
  if (nuevaCantidad > maxStock) {
    input.classList.add("shake");

    Swal.fire({
      icon: 'warning',
      title: 'Stock insuficiente',
      text: `Solo hay ${maxStock} unidades disponibles`,
      confirmButtonColor: '#b71c1c'
    });

    input.value = maxStock;

    setTimeout(() => input.classList.remove("shake"), 600);
    return;
  }

  // Enviar al backend
  fetch(`/carrito/editar/${id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ cantidad: nuevaCantidad })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      Swal.fire({
        title: 'Cantidad actualizada',
        icon: 'success',
        timer: 1200,
        showConfirmButton: false
      }).then(() => location.reload());
    } else {
      Swal.fire('Error', data.error, 'error');
      setTimeout(() => location.reload(), 1200);
    }
  });
}


/* ===========================
   ELIMINAR ITEM
=========================== */
function eliminarItem(id) {
  Swal.fire({
    title: '¬øEliminar producto?',
    text: 'Se eliminar√° de tu bolsa.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/carrito/eliminar/${id}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          Swal.fire({
            title: 'Eliminado',
            text: 'El producto se elimin√≥ correctamente.',
            icon: 'success',
            timer: 1200,
            showConfirmButton: false
          }).then(() => location.reload());
        } else {
          Swal.fire('Error', data.error, 'error');
        }
      });
    }
  });
}


/* ===========================
   MODAL DE PAGO (SIN CAMBIOS)
=========================== */
document.getElementById('btnPagar')?.addEventListener('click', async () => {
  const { value: formValues } = await Swal.fire({
    title: 'Confirmar pedido',
    customClass: { popup: 'bb-checkout' },
    html: `
      <div class="bb-grid">
        <div class="bb-card">
          <div class="bb-h2">Entrega</div>
          <label class="bb-label">Tipo de entrega</label>
          <div class="bb-radio" id="bb-entrega">
            <label><input type="radio" name="bb-entrega" value="local" checked> Recoger en local</label>
            <label><input type="radio" name="bb-entrega" value="domicilio"> Env√≠o a domicilio</label>
          </div>

          <div id="bb-direccion-wrap" style="margin-top:10px; display:none;">
            <label class="bb-label">Direcci√≥n de entrega</label>
            <textarea id="bb-direccion" class="bb-textarea" placeholder="Colonia, calle..."></textarea>
          </div>
        </div>

        <div class="bb-card">
          <div class="bb-h2">Datos y pago</div>

          <label class="bb-label">Nombre completo</label>
          <input id="swal-nombre" class="bb-input" value="{{ request.user.nombre|default:'' }}" disabled>

          <label class="bb-label">Tel√©fono</label>
          <input
            id="swal-telefono"
            class="bb-input"
            value="{{ request.user.telefono|default:'' }}"
            {% if request.user.telefono %}disabled{% endif %}
            placeholder="Ingresa tu tel√©fono"
          />


          <label class="bb-label">M√©todo de pago</label>
          <select id="swal-metodo" class="bb-select">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
          </select>

          <div id="bb-numero-tarjeta-wrap" style="margin-top:10px; display:none;">
            <label class="bb-label">N√∫mero de tarjeta</label>
            <input id="bb-numero-tarjeta" class="bb-input" placeholder="Solo d√≠gitos" inputmode="numeric" maxlength="19">
            <div class="bb-muted">Se requieren 12 a 19 d√≠gitos.</div>
          </div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Confirmar',
    cancelButtonText: 'Cancelar',
    focusConfirm: false,
    didOpen: () => {

      // Cambios de entrega
      const entregaWrap = document.getElementById('bb-entrega');
      const direccionWrap = document.getElementById('bb-direccion-wrap');

      const toggleEntrega = () => {
        const valor = entregaWrap.querySelector('input:checked').value;
        direccionWrap.style.display = valor === 'domicilio' ? 'block' : 'none';
      };
      entregaWrap.addEventListener('change', toggleEntrega);
      toggleEntrega();

      // Pago
      const metodoSel = document.getElementById('swal-metodo');
      const tarjetaWrap = document.getElementById('bb-numero-tarjeta-wrap');
      metodoSel.addEventListener('change', () => {
        tarjetaWrap.style.display = metodoSel.value === 'tarjeta' ? 'block' : 'none';
      });
    },
    preConfirm: () => {
      const nombre = document.getElementById('swal-nombre').value.trim();
      const telefono = document.getElementById('swal-telefono').value.trim();
      const entrega = document.querySelector('input[name="bb-entrega"]:checked').value;
      const metodo = document.getElementById('swal-metodo').value;
      const direccion = document.getElementById('bb-direccion').value.trim();
      const tarjeta = document.getElementById('bb-numero-tarjeta').value.trim();

      if (!nombre) return Swal.showValidationMessage("Nombre inv√°lido");
      if (!telefono) return Swal.showValidationMessage("Tel√©fono inv√°lido");
      if (entrega === 'domicilio' && !direccion)
        return Swal.showValidationMessage("La direcci√≥n es obligatoria");
      if (metodo === 'tarjeta' && (tarjeta.length < 12 || tarjeta.length > 19))
        return Swal.showValidationMessage("N√∫mero de tarjeta inv√°lido");

      return { nombre, telefono, entrega, metodo, direccion, numero_pago: tarjeta };
    }
  });

  if (!formValues) return;

  const resp = await fetch("{% url 'carrito_checkout' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify(formValues)
  });
  const data = await resp.json();

  if (data.ok) {
    await Swal.fire({
      icon: 'success',
      title: '¬°Pedido confirmado!',
      html: `
        <p>Tu pedido fue registrado correctamente.</p>
        <p>Total: <b>$${data.total}</b></p>
        ${data.factura_url ? `<a href="${data.factura_url}" target="_blank">üìÑ Ver factura</a>` : ''}
      `,
      confirmButtonColor: '#27ae60'
    });

    location.reload();
  } else {
    Swal.fire('Error', data.error, 'error');
  }
});

</script>

{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Carrito - BullBurger{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/cliente_style.css' %}">

<section class="cliente-bg">
  <h1 class="titulo"> MI BOLSA</h1>
  <hr class="separador">

  {% if pedidos %}
  {% for item in pedidos %}
<div class="carrito-item">
  <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="item-img">

  <div class="item-info">
    <h3>{{ item.producto.nombre }}</h3>
    <p class="item-descripcion">{{ item.producto.descripcion|default:"Sin descripci칩n" }}</p>
    <p class="item-precio">${{ item.producto.precio }}</p>

    <div class="cantidad-container">
      <label for="cantidad-{{ item.id }}">Cantidad:</label>
      <input type="number" id="cantidad-{{ item.id }}" value="{{ item.cantidad }}" min="1" class="input-cantidad">

      <div class="acciones-container">
        <button class="btn-editar" onclick="editarCantidad('{{ item.id }}')">Actualizar</button>
        <button class="btn-eliminar" onclick="eliminarItem('{{ item.id }}')">Eliminar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

  <div class="carrito-total">
    <p>Total: <span id="total">${{ total }}</span></p>
    <button class="btn-pagar">PAGAR BOLSA</button>
  </div>

  {% else %}
  <div class="carrito-vacio">
    <h2>游 Tu bolsa est치 vac칤a</h2>
    <a href="{% url 'menu_cliente' %}" class="btn-volver">Volver al men칰</a>
  </div>
  {% endif %}
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function eliminarItem(id) {
  Swal.fire({
    title: '쮼liminar producto?',
    text: 'Esta acci칩n eliminar치 el producto de tu bolsa.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S칤, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/carrito/eliminar/${id}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          Swal.fire({
            title: 'Eliminado',
            text: 'El producto se elimin칩 correctamente.',
            icon: 'success',
            timer: 1200,
            showConfirmButton: false
          }).then(() => location.reload());
        } else {
          Swal.fire('Error', data.error || 'No se pudo eliminar el producto', 'error');
        }
      });
    }
  });
}

function editarCantidad(id) {
  const nuevaCantidad = document.getElementById(`cantidad-${id}`).value;
  fetch(`/carrito/editar/${id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ cantidad: nuevaCantidad })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      Swal.fire({
        title: 'Cantidad actualizada',
        text: 'Tu bolsa se ha modificado correctamente.',
        icon: 'success',
        timer: 1200,
        showConfirmButton: false
      }).then(() => location.reload());
    } else {
      Swal.fire('Error', data.error || 'No se pudo actualizar la cantidad', 'error');
    }
  });
}
</script>

{% endblock %}
